<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>pymata_express.pymata_express API documentation</title>
    <meta name="description" content="Copyright (c) 2018-2019 Alan Yorinks All rights reserved.

This program is free software; you can re..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sa { color: #BA2121 } /* Literal.String.Affix */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .dl { color: #BA2121 } /* Literal.String.Delimiter */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .fm { color: #0000FF } /* Name.Function.Magic */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .vm { color: #19177C } /* Name.Variable.Magic */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">


    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#pymata_express.pymata_express.PymataExpress">PymataExpress</a></span>
        
          
  <ul>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.__init__">__init__</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.analog_read">analog_read</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.analog_write">analog_write</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.digital_pin_write">digital_pin_write</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.digital_read">digital_read</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.digital_write">digital_write</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.disable_analog_reporting">disable_analog_reporting</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.disable_digital_reporting">disable_digital_reporting</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.enable_analog_reporting">enable_analog_reporting</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.enable_digital_reporting">enable_digital_reporting</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.extended_analog">extended_analog</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_analog_map">get_analog_map</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_capability_report">get_capability_report</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_firmware_version">get_firmware_version</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_pin_state">get_pin_state</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_protocol_version">get_protocol_version</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.get_pymata_version">get_pymata_version</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.i2c_config">i2c_config</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.i2c_read_data">i2c_read_data</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.i2c_read_request">i2c_read_request</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.i2c_write_request">i2c_write_request</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.keep_alive">keep_alive</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.play_tone">play_tone</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.send_reset">send_reset</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.servo_config">servo_config</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.set_pin_mode">set_pin_mode</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.set_sampling_interval">set_sampling_interval</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.shutdown">shutdown</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.sleep">sleep</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.sonar_config">sonar_config</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.sonar_data_retrieve">sonar_data_retrieve</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.start">start</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.start_aio">start_aio</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.stepper_config">stepper_config</a></li>
    <li class="mono"><a href="#pymata_express.pymata_express.PymataExpress.stepper_step">stepper_step</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">pymata_express.pymata_express</span> module</h1>
  <p>Copyright (c) 2018-2019 Alan Yorinks All rights reserved.</p>
<p>This program is free software; you can redistribute it and/or
modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE
Version 3 as published by the Free Software Foundation; either
or (at your option) any later version.
This library is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
General Public License for more details.</p>
<p>You should have received a copy of the GNU AFFERO GENERAL PUBLIC LICENSE
along with this library; if not, write to the Free Software
Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express" class="source">
    <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"> Copyright (c) 2018-2019 Alan Yorinks All rights reserved.</span>

<span class="sd"> This program is free software; you can redistribute it and/or</span>
<span class="sd"> modify it under the terms of the GNU AFFERO GENERAL PUBLIC LICENSE</span>
<span class="sd"> Version 3 as published by the Free Software Foundation; either</span>
<span class="sd"> or (at your option) any later version.</span>
<span class="sd"> This library is distributed in the hope that it will be useful,</span>
<span class="sd"> but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="sd"> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="sd"> General Public License for more details.</span>

<span class="sd"> You should have received a copy of the GNU AFFERO GENERAL PUBLIC LICENSE</span>
<span class="sd"> along with this library; if not, write to the Free Software</span>
<span class="sd"> Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># noinspection PyCompatibility</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># noinspection PyPackageRequirements</span>
<span class="kn">from</span> <span class="nn">serial.tools</span> <span class="kn">import</span> <span class="n">list_ports</span>

<span class="c1"># noinspection PyPackageRequirements</span>
<span class="kn">from</span> <span class="nn">pymata_express.constants</span> <span class="kn">import</span> <span class="n">Constants</span>
<span class="kn">from</span> <span class="nn">pymata_express.pin_data</span> <span class="kn">import</span> <span class="n">PinData</span>
<span class="kn">from</span> <span class="nn">pymata_express.private_constants</span> <span class="kn">import</span> <span class="n">PrivateConstants</span>
<span class="kn">from</span> <span class="nn">pymata_express.pymata_express_serial</span> <span class="kn">import</span> <span class="n">PymataExpressSerial</span>


<span class="c1"># noinspection PyCallingNonCallable,PyCallingNonCallable,PyPep8,PyBroadException,PyBroadException,PyCompatibility</span>
<span class="k">class</span> <span class="nc">PymataExpress</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class exposes and implements the PymataExpress API.</span>
<span class="sd">    It includes the public API methods as well as</span>
<span class="sd">    a set of private methods. This is an asyncio API</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">com_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baud_rate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span>
                 <span class="n">arduino_instance_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arduino_wait</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">sleep_tune</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">autostart</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">analog_report_differential</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If you are using the Firmata Express Arduino sketch,</span>
<span class="sd">        and have a single Arduino connected to your computer,</span>
<span class="sd">        then you may accept all the default values.</span>

<span class="sd">        If you are using some other Firmata sketch, then</span>
<span class="sd">        you must specify both the com_port and baudrate.</span>

<span class="sd">        :param com_port: e.g. COM3 or /dev/ttyACM0.</span>

<span class="sd">        :param baud_rate: Match this to the Firmata sketch in use.</span>

<span class="sd">        :param arduino_instance_id: If you are using the Firmata</span>
<span class="sd">                                    Express sketch, match this</span>
<span class="sd">                                    value to that in the sketch.</span>

<span class="sd">        :param arduino_wait: Amount of time to wait for an Arduino to</span>
<span class="sd">                             fully reset itself.</span>

<span class="sd">        :param sleep_tune: A tuning parameter used by PymataExpressSerial</span>

<span class="sd">        :param autostart: If you wish to call the start method within</span>
<span class="sd">                          your application, then set this to False.</span>

<span class="sd">        :param analog_report_differential: When comparing the currently</span>
<span class="sd">                                           reported analog value with the</span>
<span class="sd">                                           previous, this differential must</span>
<span class="sd">                                           be met for a the callback method</span>
<span class="sd">                                           to be called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check to make sure that Python interpreter is version 3.7 or greater</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>
        <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s2">&quot;ERROR: Python 3.7 or greater is required for use of this program.&quot;</span><span class="p">)</span>

        <span class="c1"># save input parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">com_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">baud_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span> <span class="o">=</span> <span class="n">arduino_instance_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span> <span class="o">=</span> <span class="n">arduino_wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span> <span class="o">=</span> <span class="n">sleep_tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autostart</span> <span class="o">=</span> <span class="n">autostart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_report_differential</span> <span class="o">=</span> <span class="n">analog_report_differential</span>

        <span class="c1"># a list of PinData objects - one for each pin segregated by pin type</span>
        <span class="c1"># see pin_data.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># serial port in use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># An i2c_map entry consists of a device i2c address as the key, and</span>
        <span class="c1">#  the value of the key consists of a dictionary containing 3 entries.</span>
        <span class="c1">#  The first entry. &#39;value&#39; contains the last value reported, and</span>
        <span class="c1"># the second, &#39;callback&#39; contains a reference to a callback function.</span>
        <span class="c1"># the third, callback_type contains the callback type selector</span>
        <span class="c1">#  (None = Direct, 1 = await)</span>
        <span class="c1"># For example:</span>
        <span class="c1"># {12345: {&#39;value&#39;: 23, &#39;callback&#39;: None, &#39;callback_type: None}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># the active_sonar_map maps the sonar trigger pin number (the key)</span>
        <span class="c1"># to the current data value returned</span>
        <span class="c1"># if a callback was specified, it is stored in the map as well.</span>
        <span class="c1"># an entry in the map consists of:</span>
        <span class="c1">#   pin: [callback,, callback_type, [current_data_returned]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># keep alive variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># first analog pin number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># asyncio loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="c1"># generic asyncio task holder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># flag to indicate we are in shutdown mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># this dictionary for mapping incoming Firmata message types to</span>
        <span class="c1"># handlers for the messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_version</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_firmware</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_capability_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_mapping_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_pin_state_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_string_data</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REPLY</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_i2c_reply</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_sonar_data</span><span class="p">,}</span>

        <span class="c1"># report query results are stored in this dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;pymata_aio Version &#39;</span> <span class="o">+</span>
                              <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span><span class="p">,</span>
                              <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Copyright (c) 2018-2019 Alan Yorinks All &#39;</span>
                              <span class="s1">&#39;rights reserved.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
            <span class="c1"># user did not specify a com_port</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_arduino</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># com_port specified - set com_port and baud rate</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manual_open</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Arduino found and connected to &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">))</span>

        <span class="c1"># no com_port found - raise a runtime exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No Arduino Found or User Aborted Program&#39;</span><span class="p">)</span>

        <span class="c1"># start the application</span>
        <span class="k">if</span> <span class="n">autostart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method may be called directly, but first set the autostart</span>
<span class="sd">        parameter to false.</span>

<span class="sd">        This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">        a non-asyncio function - it used by __init__.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="c1"># get arduino firmware version and print it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Retrieving Arduino Firmware ID...&#39;</span><span class="p">)</span>
            <span class="n">firmware_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">())</span>

            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Is your serial cable plugged in and do you have the correct Firmata sketch loaded?&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Is the COM port correct?&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>

            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
                  <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">start_aio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method may be called directly, but first set the autostart</span>
<span class="sd">        parameter to false.</span>

<span class="sd">        This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">        an asyncio function.</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="c1"># start the command dispatcher loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>

        <span class="c1"># get arduino firmware version and print it</span>
        <span class="n">firmware_version</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">firmware_version</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Firmware Version retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Firmata sketch uploaded to the board and are connected&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;to the correct serial port.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>

        <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
                  <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_find_arduino</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will search all potential serial ports for an Arduino</span>
<span class="sd">        containing a sketch that has a matching arduino_instance_id as</span>
<span class="sd">        specified in the input parameters of this class.</span>

<span class="sd">        This is used explicitly with the FirmataExpress sketch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># a list of serial ports to be checked</span>
        <span class="n">serial_ports</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Opening all potential serial ports...&#39;</span><span class="p">)</span>
        <span class="n">the_ports_list</span> <span class="o">=</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">the_ports_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">pid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># print(&#39;\nChecking {}&#39;.format(port.device))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataExpressSerial</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span><span class="p">)</span>
            <span class="c1"># create a list of serial ports that we opened</span>
            <span class="n">serial_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="p">)</span>

            <span class="c1"># display to the user</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># clear out any possible data in the input buffer</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>

        <span class="c1"># wait for arduino to reset</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Waiting {} seconds(arduino_wait) for Arduino devices to &#39;</span>
              <span class="s1">&#39;reset...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Searching for an Arduino configured with an arduino_instance = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">serial_port</span> <span class="ow">in</span> <span class="n">serial_ports</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">serial_port</span>
            <span class="c1"># send the &quot;are you there&quot; sysex request to the arduino</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ARE_YOU_THERE</span><span class="p">)</span>

            <span class="c1"># wait until the END_SYSEX comes back</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf7</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i_am_here</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># make sure we get back the expected length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># convert i_am_here to a list</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span>

            <span class="c1"># check sysex command is I_AM_HERE</span>
            <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I_AM_HERE</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># got an I am here message - is it the correct ID?</span>
                <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">serial_port</span><span class="o">.</span><span class="n">com_port</span>
                    <span class="k">return</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_manual_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Com port was specified by the user - try to open up that port</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if port is not found, a serial exception will be thrown</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Opening {} ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataExpressSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Waiting {} seconds for the Arduino To Reset.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">==</span> <span class="mi">115200</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ARE_YOU_THERE</span><span class="p">)</span>

            <span class="c1"># await asyncio.sleep(1)</span>
            <span class="c1"># wait until the END_SYSEX comes back</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf7</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># convert i_am_here to a list</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid Arduino ID reply length&#39;</span><span class="p">)</span>

            <span class="c1"># check sysex command is I_AM_HERE</span>
            <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I_AM_HERE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Retrieving ID From Arduino Failed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># got an I am here message - is it the correct ID?</span>
                <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid Arduino identifier retrieved&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified analog pin.</span>

<span class="sd">        :param pin: Analog pin number (ex. A2 is specified as 2)</span>

<span class="sd">        :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the selected pin to the specified value.</span>

<span class="sd">        :param pin: PWM pin number</span>

<span class="sd">        :param value: Pin value (0 - 0x4000)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_analog</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified digital pin.</span>

<span class="sd">        :param pin: Digital pin number</span>

<span class="sd">        :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_pin_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the specified pin to the specified value directly without port manipulation.</span>

<span class="sd">        :param pin: pin number</span>

<span class="sd">        :param value: pin value</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_DIGITAL_PIN_VALUE</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the specified pin to the specified value.</span>

<span class="sd">        :param pin: pin number</span>

<span class="sd">        :param value: pin value</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The command value is not a fixed value, but needs to be calculated</span>
        <span class="c1"># using the pin&#39;s port number</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>

        <span class="n">calculated_command</span> <span class="o">=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span> <span class="o">+</span> <span class="n">port</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c1"># Calculate the value for the pin&#39;s position in the port mask</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>

        <span class="c1"># Assemble the command</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">calculated_command</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables analog reporting for a single analog pin.</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables digital reporting. By turning reporting off for this pin,</span>
<span class="sd">        Reporting is disabled for all 8 bits in the &quot;port&quot;</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables analog reporting. By turning reporting on for a single pin,</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables digital reporting. By turning reporting on for all 8 bits</span>
<span class="sd">        in the &quot;port&quot; - this is part of Firmata&#39;s protocol specification.</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">extended_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will send an extended-data analog write command to the</span>
<span class="sd">        selected pin.</span>

<span class="sd">        :param pin: 0 - 127</span>

<span class="sd">        :param data: 0 - 0xfffff</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analog_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">EXTENDED_ANALOG</span><span class="p">,</span> <span class="n">analog_data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_analog_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests a Firmata analog map query and returns the results.</span>

<span class="sd">        :returns: An analog map response or None if a timeout occurs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the current time to make sure a report is retrieved</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># if we do not have existing report results, send a Firmata</span>
        <span class="c1"># message to request one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_QUERY</span><span class="p">)</span>
            <span class="c1"># wait for the report results to return for 4 seconds</span>
            <span class="c1"># if the timer expires, shutdown</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests and returns a Firmata capability query report</span>

<span class="sd">        :returns: A capability report in the form of a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_QUERY</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_firmware_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the Firmata firmware version</span>

<span class="sd">        :returns: Firmata firmware version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_protocol_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method returns the major and minor values for the protocol</span>
<span class="sd">        version, i.e. 2.4</span>

<span class="sd">        :returns: Firmata protocol version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">])</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves a pin state report for the specified pin</span>

<span class="sd">        :param pin: Pin of interest</span>

<span class="sd">        :returns: pin state report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># place pin in a list to keep _send_sysex happy</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_QUERY</span><span class="p">,</span> <span class="p">[</span><span class="n">pin</span><span class="p">])</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="n">pin_state_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">pin_state_report</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pymata_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the PyMata version number</span>

<span class="sd">        :returns: PyMata version number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span>

    <span class="c1"># noinspection PyIncorrectDocstring</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_delay_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: THIS METHOD MUST BE CALLED BEFORE ANY I2C REQUEST IS MADE</span>
<span class="sd">        This method initializes Firmata for I2c operations.</span>

<span class="sd">        :param read_delay_time (in microseconds): an optional parameter,</span>
<span class="sd">                                                  default is 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_delay_time</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">read_delay_time</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves cached i2c data to support a polling mode.</span>

<span class="sd">        :param address: I2C device address</span>

<span class="sd">        :returns: Last cached value read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">,</span>
                               <span class="n">read_type</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests the read of an i2c device. Results are retrieved</span>
<span class="sd">        by a call to i2c_get_read_data(). or by callback.</span>

<span class="sd">        If a callback method is provided, when data is received from the</span>
<span class="sd">        device it will be sent to the callback method.</span>
<span class="sd">        Some devices require that transmission be restarted</span>
<span class="sd">        (e.g. MMA8452Q accelerometer).</span>
<span class="sd">        Use Constants.I2C_READ | Constants.I2C_END_TX_MASK for those cases.</span>

<span class="sd">        :param address: i2c device address</span>

<span class="sd">        :param register: register number (can be set to zero)</span>

<span class="sd">        :param number_of_bytes: number of bytes expected to be returned</span>

<span class="sd">        :param read_type: I2C_READ  or I2C_READ_CONTINUOUSLY. I2C_END_TX_MASK</span>
<span class="sd">                          may be OR&#39;ed when required</span>

<span class="sd">        :param cb: Optional callback function to report i2c data as a</span>
<span class="sd">                   result of read command</span>

<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c1"># self.i2c_map[address] = [None, cb]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="p">,</span>
                                     <span class="s1">&#39;callback_type&#39;</span><span class="p">:</span> <span class="n">cb_type</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">read_type</span><span class="p">,</span> <span class="n">register</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">register</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="n">number_of_bytes</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_write_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to an i2c device.</span>

<span class="sd">        :param address: i2c device address</span>

<span class="sd">        :param args: A variable number of bytes to be sent to the device</span>
<span class="sd">                     passed in as a list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">I2C_WRITE</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">item_lsb</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_lsb</span><span class="p">)</span>
            <span class="n">item_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_msb</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">margin</span><span class="o">=.</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically send a keep alive message to the Arduino.</span>
<span class="sd">        Frequency of keep alive transmission is calculated as follows:</span>
<span class="sd">        keep_alive_sent = period - (period * margin)</span>


<span class="sd">        :param period: Time period between keepalives. Range is 0-10 seconds.</span>
<span class="sd">                       0 disables the keepalive mechanism.</span>

<span class="sd">        :param margin: Safety margin to assure keepalives are sent before</span>
<span class="sd">                    period expires. Range is 0.1 to 0.9</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)))</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">KEEP_ALIVE</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">play_tone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">tone_command</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will call the Tone library for the selected pin.</span>
<span class="sd">        It requires FirmataPlus to be loaded onto the arduino</span>

<span class="sd">        If the tone command is set to TONE_TONE, then the specified</span>
<span class="sd">        tone will be played.</span>

<span class="sd">        Else, if the tone command is TONE_NO_TONE, then any currently</span>
<span class="sd">        playing tone will be disabled.</span>

<span class="sd">        :param pin: Pin number</span>

<span class="sd">        :param tone_command: Either TONE_TONE, or TONE_NO_TONE</span>

<span class="sd">        :param frequency: Frequency of tone</span>

<span class="sd">        :param duration: Duration of tone in milliseconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># convert the integer values to bytes</span>
        <span class="k">if</span> <span class="n">tone_command</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">TONE_TONE</span><span class="p">:</span>
            <span class="c1"># duration is specified</span>
            <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                        <span class="n">duration</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
                        <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># turn off tone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">TONE_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">send_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a Sysex reset command to the arduino</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SYSTEM_RESET</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">servo_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span><span class="o">=</span><span class="mi">544</span><span class="p">,</span> <span class="n">max_pulse</span><span class="o">=</span><span class="mi">2400</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure a pin as a servo pin. Set pulse min, max in ms.</span>
<span class="sd">        Use this method (not set_pin_mode) to configure a pin for servo</span>
<span class="sd">        operation.</span>

<span class="sd">        :param pin: Servo Pin.</span>

<span class="sd">        :param min_pulse: Min pulse width in ms.</span>

<span class="sd">        :param max_pulse: Max pulse width in ms.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">min_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">max_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">max_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SERVO_CONFIG</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_pin_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">callback_type</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">CB_TYPE_ASYNCIO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sets the pin mode for the specified pin.</span>
<span class="sd">        For Servo, use servo_config() instead.</span>

<span class="sd">        :param pin_number: Arduino Pin Number</span>

<span class="sd">        :param pin_state: INPUT/OUTPUT/ANALOG/PWM/PULLUP - for SERVO use</span>
<span class="sd">                          servo_config()</span>

<span class="sd">        :param callback: Optional: A reference to a call back function to be</span>
<span class="sd">                         called when pin data value changes</span>

<span class="sd">        :param callback_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># There is a potential start up race condition when running pymata3.</span>
        <span class="c1"># This is a workaround for that race condition</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">):</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;set_pin_mode: callback ignored for &#39;</span>
                                         <span class="s1">&#39;pin state:&#39;</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">))</span>

        <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_state</span>

        <span class="k">if</span> <span class="n">pin_mode</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="n">pin_number</span> <span class="o">=</span> <span class="n">pin_number</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_PIN_MODE</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_mode</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_analog_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_digital_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_sampling_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sends the desired sampling interval to Firmata.</span>
<span class="sd">        Note: Standard Firmata  will ignore any interval less than</span>
<span class="sd">              10 milliseconds</span>

<span class="sd">        :param interval: Integer value for desired sampling interval</span>
<span class="sd">                         in milliseconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">interval</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method attempts an orderly shutdown</span>
<span class="sd">        If any exceptions are thrown, just ignore them.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># stop all reporting - both analog and digital</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)):</span>
           <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_analog_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)):</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_digital_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is a proxy method for asyncio.sleep</span>

<span class="sd">        :param sleep_time: Sleep interval in seconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;sleep exception&#39;</span><span class="p">):</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">ping_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the pins,ping interval and maximum distance for an HC-SR04</span>
<span class="sd">        type device.</span>
<span class="sd">        Single pin configuration may be used. To do so, set both the trigger</span>
<span class="sd">        and echo pins to the same value.</span>
<span class="sd">        Up to a maximum of 6 SONAR devices is supported</span>
<span class="sd">        If the maximum is exceeded a message is sent to the console and the</span>
<span class="sd">        request is ignored.</span>
<span class="sd">        NOTE: data is measured in centimeters</span>

<span class="sd">        :param trigger_pin: The pin number of for the trigger (transmitter).</span>

<span class="sd">        :param echo_pin: The pin number for the received echo.</span>

<span class="sd">        :param cb: optional callback function to report sonar data changes</span>

<span class="sd">        :param ping_interval: Minimum interval between pings. Lowest number</span>
<span class="sd">                              to use is 33 ms. Max is 127ms.</span>

<span class="sd">        :param max_distance: Maximum distance in cm. Max is 200.</span>

<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if there is an entry for the trigger pin in existence, just exit</span>
        <span class="k">if</span> <span class="n">trigger_pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">max_distance</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">max_distance_lsb</span> <span class="o">=</span> <span class="n">max_distance</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">max_distance_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_distance</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">ping_interval</span><span class="p">,</span> <span class="n">max_distance_lsb</span><span class="p">,</span>
                <span class="n">max_distance_msb</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">echo_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="c1"># update the ping data map for this pin</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sonar_config: maximum number of devices assigned&#39;</span>
                  <span class="s1">&#39; - ignoring request&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">trigger_pin</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_data_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve Ping (HC-SR04 type) data. The data is presented as a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        The &#39;key&#39; is the trigger pin specified in sonar_config()</span>
<span class="sd">        and the &#39;data&#39; is the current measured distance (in centimeters)</span>
<span class="sd">        for that pin. If there is no data, the value is set to None.</span>

<span class="sd">        :param trigger_pin: key into sonar data map</span>

<span class="sd">        :returns: active_sonar_map</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_per_revolution</span><span class="p">,</span> <span class="n">stepper_pins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure stepper motor prior to operation.</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param steps_per_revolution: number of steps per motor revolution</span>

<span class="sd">        :param stepper_pins: a list of control pin numbers - either 4 or 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_CONFIGURE</span><span class="p">,</span> <span class="n">steps_per_revolution</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="p">(</span><span class="n">steps_per_revolution</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">])</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_speed</span><span class="p">,</span> <span class="n">number_of_steps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move a stepper motor for the number of steps at the specified speed</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param motor_speed: 21 bits of data to set motor speed</span>

<span class="sd">        :param number_of_steps: 14 bits for number of steps &amp; direction</span>
<span class="sd">                                positive is forward, negative is reverse</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">number_of_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">abs_number_of_steps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number_of_steps</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_STEP</span><span class="p">,</span> <span class="n">motor_speed</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="n">abs_number_of_steps</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">abs_number_of_steps</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">direction</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_arduino_report_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private method.</span>
<span class="sd">        It continually accepts and interprets data coming from Firmata,and then</span>
<span class="sd">        dispatches the correct handler to process the data.</span>

<span class="sd">        :returns: This method never returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sysex commands are assembled into this list for processing</span>
        <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># if this is a SYSEX command, then assemble the entire</span>
                <span class="c1"># command process it</span>
                <span class="k">if</span> <span class="n">next_command_byte</span> <span class="o">==</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">next_command_byte</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">:</span>
                        <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                        <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">sysex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">sysex</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">sysex</span><span class="p">)</span>
                    <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                <span class="c1"># if this is an analog message, process it.</span>
                <span class="k">elif</span> <span class="mh">0xE0</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;=</span> <span class="mh">0xEF</span><span class="p">:</span>
                    <span class="c1"># analog message</span>
                    <span class="c1"># assemble the entire analog message in command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># get the pin number for the message</span>
                    <span class="n">pin</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                    <span class="c1"># get the next 2 bytes for the command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># process the analog message</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c1"># handle the digital message</span>
                <span class="k">elif</span> <span class="mh">0x90</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;=</span> <span class="mh">0x9F</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c1"># handle all other messages by looking them up in the</span>
                <span class="c1"># command dictionary</span>
                <span class="k">elif</span> <span class="n">next_command_byte</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">next_command_byte</span><span class="p">]()</span>
                    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we need to yield back to the loop</span>
                    <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Firmata message handlers</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_mapping_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for the analog mapping response message.</span>

<span class="sd">        :param data: response data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for analog messages.</span>

<span class="sd">        :param data: message data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>

        <span class="c1"># only report when there is a change in value</span>
        <span class="n">differential</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">differential</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_report_differential</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span> <span class="o">=</span> <span class="n">time_stamp</span>

            <span class="c1"># append pin number, pin value, and pin type to return value and return as a list</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_capability_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for capability report responses.</span>

<span class="sd">        :param data: capability report</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_digital_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for Digital Messages.</span>

<span class="sd">        :param data: digital message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">port_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">))):</span>
            <span class="c1"># get pin value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">port_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span>

            <span class="c1"># set the current value in the pin structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span> <span class="o">=</span> <span class="n">time_stamp</span>

            <span class="c1"># append pin number, pin value, and pin type to return value and return as a list</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># self.digital_pins[pin].cb(data)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">port_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_encoder_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles encoder data messages.</span>

<span class="sd">        :param data: encoder data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>
        <span class="c1"># set value so that it shows positive and negative values</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">-=</span> <span class="mi">16384</span>
        <span class="c1"># if this value is different that is what is already in the</span>
        <span class="c1"># table store it and check for callback</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="c1"># self.digital_pins[pin].cb([pin, val])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># self.digital_pins[pin].cb(data)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># noinspection PyDictCreation</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_i2c_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles replies to i2c_read requests. It stores the data</span>
<span class="sd">        for each i2c device address in a dictionary called i2c_map.</span>
<span class="sd">        The data may be retrieved via a polling call to i2c_get_read_data().</span>
<span class="sd">        It a callback was specified in pymata.i2c_read, the raw data is sent</span>
<span class="sd">        through the callback</span>

<span class="sd">        :param data: raw data returned from i2c device</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove the start and end sysex commands from the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># reassemble the data from the firmata 2 byte format</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># if we have an entry in the i2c_map, proceed</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c1"># get 2 bytes, combine them and append to reply data list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">combined_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

            <span class="c1"># place the data in the i2c map without storing the address byte or</span>
            <span class="c1">#  register byte (returned data only)</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">map_entry</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_entry</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">)</span>
            <span class="n">cb_type</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
                <span class="c1"># send everything, including address and register bytes back</span>
                <span class="c1"># to caller</span>
                <span class="k">if</span> <span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="n">cb</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">reply_data</span><span class="p">)</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_pin_state_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles pin state query response messages.</span>

<span class="sd">        :param data: Pin state message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_firmware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method handles the sysex &#39;report firmware&#39; command sent by</span>
<span class="sd">        Firmata (0x79).</span>
<span class="sd">        It assembles the firmware version by concatenating the major and</span>
<span class="sd">         minor version number components and</span>
<span class="sd">        the firmware identifier into a string.</span>
<span class="sd">        e.g. &quot;2.3 StandardFirmata.ino&quot;</span>

<span class="sd">        :param sysex_data: Sysex data sent from Firmata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first byte after command is major number</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>

        <span class="c1"># next byte is minor number</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># append a dot to major number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>

        <span class="c1"># append minor number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="c1"># add a space after the major and minor numbers</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

        <span class="c1"># slice the identifier - from the first byte after the minor</span>
        <span class="c1">#  number up until, but not including the END_SYSEX byte</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">firmware_name_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># convert each element from two 7-bit bytes into characters, then add each</span>
        <span class="c1"># character to the version string</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">firmware_name_iterator</span><span class="p">:</span>
            <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">firmware_name_iterator</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>

        <span class="c1"># store the value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method reads the following 2 bytes after the report version</span>
<span class="sd">        command (0xF9 - non sysex).</span>
<span class="sd">        The first byte is the major number and the second byte is the</span>
<span class="sd">        minor number.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get next two bytes</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_sonar_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the incoming sonar data message and stores</span>
<span class="sd">        the data in the response table.</span>

<span class="sd">        :param data: Message data from Firmata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin_number</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># check if value changed since last reading</span>
            <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>
                <span class="c1"># Do a callback if one is specified in the table</span>
                <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># if this is an asyncio callback type</span>
                    <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
                    <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">await</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">reply_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># sonar_pin_entry[0]([pin_number, val])</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reply_data</span><span class="p">)</span>
        <span class="c1"># update the data in the table with latest value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>

        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">_string_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is the message handler for String data messages that will be</span>
<span class="sd">        printed to the console.</span>
<span class="sd">        :param data:  message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">reply_data</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">reply_data</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    utilities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="k">def</span> <span class="nf">_format_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method formats a capability report if the user wishes to</span>
<span class="sd">        send it to the console.</span>
<span class="sd">        If log_output = True, no output is generated</span>

<span class="sd">        :param data: Capability report</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>




        <span class="n">pin_modes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Digital_Input&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Digital_Output&#39;</span><span class="p">,</span>
                     <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Analog&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;PWM&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;Servo&#39;</span><span class="p">,</span>
                     <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;Shift&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;I2C&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;One Wire&#39;</span><span class="p">,</span>
                     <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Stepper&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;Encoder&#39;</span><span class="p">}</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Capability Report&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># get index of next end marker</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Pin&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span>
                <span class="n">mode_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_modes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="n">mode_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin_mode</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">bits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{:&gt;5}{}{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">mode_str</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pin</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        The method sends a non-sysex command to Firmata.</span>

<span class="sd">        :param command:  command data</span>

<span class="sd">        :returns: length of data sent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">send_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">send_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">send_message</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;cannot send command&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_sysex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_command</span><span class="p">,</span> <span class="n">sysex_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method sends a sysex command to Firmata.</span>

<span class="sd">        :param sysex_command: sysex command</span>

<span class="sd">        :param sysex_data: data for command</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sysex_data</span><span class="p">:</span>
            <span class="n">sysex_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert the message command and data to characters</span>
        <span class="n">sysex_message</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">sysex_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sysex_data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sysex_data</span><span class="p">:</span>
                <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">sysex_message</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_wait_for_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_command</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method accumulates the requested number of bytes and</span>
<span class="sd">        then returns the full command</span>

<span class="sd">        :param current_command:  command id</span>

<span class="sd">        :param number_of_bytes:  how many bytes to wait for</span>

<span class="sd">        :returns: command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">number_of_bytes</span><span class="p">:</span>
            <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
            <span class="n">number_of_bytes</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">current_command</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">


    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="pymata_express.pymata_express.PymataExpress" class="name">class <span class="ident">PymataExpress</span></p>
      
  
    <div class="desc"><p>This class exposes and implements the PymataExpress API.
It includes the public API methods as well as
a set of private methods. This is an asyncio API</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">PymataExpress</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class exposes and implements the PymataExpress API.</span>
<span class="sd">    It includes the public API methods as well as</span>
<span class="sd">    a set of private methods. This is an asyncio API</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">com_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baud_rate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span>
                 <span class="n">arduino_instance_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arduino_wait</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                 <span class="n">sleep_tune</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">autostart</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">analog_report_differential</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If you are using the Firmata Express Arduino sketch,</span>
<span class="sd">        and have a single Arduino connected to your computer,</span>
<span class="sd">        then you may accept all the default values.</span>

<span class="sd">        If you are using some other Firmata sketch, then</span>
<span class="sd">        you must specify both the com_port and baudrate.</span>

<span class="sd">        :param com_port: e.g. COM3 or /dev/ttyACM0.</span>

<span class="sd">        :param baud_rate: Match this to the Firmata sketch in use.</span>

<span class="sd">        :param arduino_instance_id: If you are using the Firmata</span>
<span class="sd">                                    Express sketch, match this</span>
<span class="sd">                                    value to that in the sketch.</span>

<span class="sd">        :param arduino_wait: Amount of time to wait for an Arduino to</span>
<span class="sd">                             fully reset itself.</span>

<span class="sd">        :param sleep_tune: A tuning parameter used by PymataExpressSerial</span>

<span class="sd">        :param autostart: If you wish to call the start method within</span>
<span class="sd">                          your application, then set this to False.</span>

<span class="sd">        :param analog_report_differential: When comparing the currently</span>
<span class="sd">                                           reported analog value with the</span>
<span class="sd">                                           previous, this differential must</span>
<span class="sd">                                           be met for a the callback method</span>
<span class="sd">                                           to be called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check to make sure that Python interpreter is version 3.7 or greater</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>
        <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span>
                    <span class="s2">&quot;ERROR: Python 3.7 or greater is required for use of this program.&quot;</span><span class="p">)</span>

        <span class="c1"># save input parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">com_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">baud_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span> <span class="o">=</span> <span class="n">arduino_instance_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span> <span class="o">=</span> <span class="n">arduino_wait</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span> <span class="o">=</span> <span class="n">sleep_tune</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autostart</span> <span class="o">=</span> <span class="n">autostart</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_report_differential</span> <span class="o">=</span> <span class="n">analog_report_differential</span>

        <span class="c1"># a list of PinData objects - one for each pin segregated by pin type</span>
        <span class="c1"># see pin_data.py</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># serial port in use</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># An i2c_map entry consists of a device i2c address as the key, and</span>
        <span class="c1">#  the value of the key consists of a dictionary containing 3 entries.</span>
        <span class="c1">#  The first entry. &#39;value&#39; contains the last value reported, and</span>
        <span class="c1"># the second, &#39;callback&#39; contains a reference to a callback function.</span>
        <span class="c1"># the third, callback_type contains the callback type selector</span>
        <span class="c1">#  (None = Direct, 1 = await)</span>
        <span class="c1"># For example:</span>
        <span class="c1"># {12345: {&#39;value&#39;: 23, &#39;callback&#39;: None, &#39;callback_type: None}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># the active_sonar_map maps the sonar trigger pin number (the key)</span>
        <span class="c1"># to the current data value returned</span>
        <span class="c1"># if a callback was specified, it is stored in the map as well.</span>
        <span class="c1"># an entry in the map consists of:</span>
        <span class="c1">#   pin: [callback,, callback_type, [current_data_returned]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># keep alive variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># first analog pin number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># asyncio loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="c1"># generic asyncio task holder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c1"># flag to indicate we are in shutdown mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c1"># this dictionary for mapping incoming Firmata message types to</span>
        <span class="c1"># handlers for the messages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_version</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_report_firmware</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_capability_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_mapping_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_pin_state_response</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_string_data</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REPLY</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_i2c_reply</span><span class="p">,</span>
                                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_DATA</span><span class="p">:</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">_sonar_data</span><span class="p">,}</span>

        <span class="c1"># report query results are stored in this dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                                 <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;pymata_aio Version &#39;</span> <span class="o">+</span>
                              <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span><span class="p">,</span>
                              <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Copyright (c) 2018-2019 Alan Yorinks All &#39;</span>
                              <span class="s1">&#39;rights reserved.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
            <span class="c1"># user did not specify a com_port</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_arduino</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># com_port specified - set com_port and baud rate</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manual_open</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Arduino found and connected to &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">))</span>

        <span class="c1"># no com_port found - raise a runtime exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No Arduino Found or User Aborted Program&#39;</span><span class="p">)</span>

        <span class="c1"># start the application</span>
        <span class="k">if</span> <span class="n">autostart</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method may be called directly, but first set the autostart</span>
<span class="sd">        parameter to false.</span>

<span class="sd">        This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">        a non-asyncio function - it used by __init__.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

        <span class="c1"># get arduino firmware version and print it</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Retrieving Arduino Firmware ID...&#39;</span><span class="p">)</span>
            <span class="n">firmware_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">())</span>

            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Is your serial cable plugged in and do you have the correct Firmata sketch loaded?&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Is the COM port correct?&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
        <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>

            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
                  <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">start_aio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method may be called directly, but first set the autostart</span>
<span class="sd">        parameter to false.</span>

<span class="sd">        This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">        discovery.</span>
<span class="sd">        Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">        an asyncio function.</span>
<span class="sd">         &quot;&quot;&quot;</span>

        <span class="c1"># start the command dispatcher loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>

        <span class="c1"># get arduino firmware version and print it</span>
        <span class="n">firmware_version</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">firmware_version</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Firmware Version retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Firmata sketch uploaded to the board and are connected&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;to the correct serial port.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>

        <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
                  <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span>

        <span class="c1"># custom assemble the pin lists</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
            <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
                <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                      <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                      <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_find_arduino</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will search all potential serial ports for an Arduino</span>
<span class="sd">        containing a sketch that has a matching arduino_instance_id as</span>
<span class="sd">        specified in the input parameters of this class.</span>

<span class="sd">        This is used explicitly with the FirmataExpress sketch.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># a list of serial ports to be checked</span>
        <span class="n">serial_ports</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Opening all potential serial ports...&#39;</span><span class="p">)</span>
        <span class="n">the_ports_list</span> <span class="o">=</span> <span class="n">list_ports</span><span class="o">.</span><span class="n">comports</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">port</span> <span class="ow">in</span> <span class="n">the_ports_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">port</span><span class="o">.</span><span class="n">pid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># print(&#39;\nChecking {}&#39;.format(port.device))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataExpressSerial</span><span class="p">(</span><span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span><span class="p">)</span>
            <span class="c1"># create a list of serial ports that we opened</span>
            <span class="n">serial_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="p">)</span>

            <span class="c1"># display to the user</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">port</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># clear out any possible data in the input buffer</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>

        <span class="c1"># wait for arduino to reset</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Waiting {} seconds(arduino_wait) for Arduino devices to &#39;</span>
              <span class="s1">&#39;reset...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Searching for an Arduino configured with an arduino_instance = &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">serial_port</span> <span class="ow">in</span> <span class="n">serial_ports</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">serial_port</span>
            <span class="c1"># send the &quot;are you there&quot; sysex request to the arduino</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ARE_YOU_THERE</span><span class="p">)</span>

            <span class="c1"># wait until the END_SYSEX comes back</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf7</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i_am_here</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># make sure we get back the expected length</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># convert i_am_here to a list</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span>

            <span class="c1"># check sysex command is I_AM_HERE</span>
            <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I_AM_HERE</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># got an I am here message - is it the correct ID?</span>
                <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">serial_port</span><span class="o">.</span><span class="n">com_port</span>
                    <span class="k">return</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_manual_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Com port was specified by the user - try to open up that port</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if port is not found, a serial exception will be thrown</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Opening {} ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="n">PymataExpressSerial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Waiting {} seconds for the Arduino To Reset.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">))</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">==</span> <span class="mi">115200</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ARE_YOU_THERE</span><span class="p">)</span>

            <span class="c1"># await asyncio.sleep(1)</span>
            <span class="c1"># wait until the END_SYSEX comes back</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">expected</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xf7</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># convert i_am_here to a list</span>
            <span class="n">i_am_here</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i_am_here</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid Arduino ID reply length&#39;</span><span class="p">)</span>

            <span class="c1"># check sysex command is I_AM_HERE</span>
            <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I_AM_HERE</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Retrieving ID From Arduino Failed.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># got an I am here message - is it the correct ID?</span>
                <span class="k">if</span> <span class="n">i_am_here</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span><span class="p">:</span>
                    <span class="k">return</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Invalid Arduino identifier retrieved&#39;</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified analog pin.</span>

<span class="sd">        :param pin: Analog pin number (ex. A2 is specified as 2)</span>

<span class="sd">        :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">analog_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the selected pin to the specified value.</span>

<span class="sd">        :param pin: PWM pin number</span>

<span class="sd">        :param value: Pin value (0 - 0x4000)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                       <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_analog</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve the last data update for the specified digital pin.</span>

<span class="sd">        :param pin: Digital pin number</span>

<span class="sd">        :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_pin_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the specified pin to the specified value directly without port manipulation.</span>

<span class="sd">        :param pin: pin number</span>

<span class="sd">        :param value: pin value</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_DIGITAL_PIN_VALUE</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">digital_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the specified pin to the specified value.</span>

<span class="sd">        :param pin: pin number</span>

<span class="sd">        :param value: pin value</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The command value is not a fixed value, but needs to be calculated</span>
        <span class="c1"># using the pin&#39;s port number</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>

        <span class="n">calculated_command</span> <span class="o">=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span> <span class="o">+</span> <span class="n">port</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
        <span class="c1"># Calculate the value for the pin&#39;s position in the port mask</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>

        <span class="c1"># Assemble the command</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">calculated_command</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables analog reporting for a single analog pin.</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">disable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Disables digital reporting. By turning reporting off for this pin,</span>
<span class="sd">        Reporting is disabled for all 8 bits in the &quot;port&quot;</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables analog reporting. By turning reporting on for a single pin,</span>

<span class="sd">        :param pin: Analog pin number. For example for A0, the number is 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">enable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Enables digital reporting. By turning reporting on for all 8 bits</span>
<span class="sd">        in the &quot;port&quot; - this is part of Firmata&#39;s protocol specification.</span>

<span class="sd">        :param pin: Pin and all pins for this port</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">            &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
                   <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">extended_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will send an extended-data analog write command to the</span>
<span class="sd">        selected pin.</span>

<span class="sd">        :param pin: 0 - 127</span>

<span class="sd">        :param data: 0 - 0xfffff</span>

<span class="sd">        :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">analog_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">EXTENDED_ANALOG</span><span class="p">,</span> <span class="n">analog_data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_analog_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests a Firmata analog map query and returns the results.</span>

<span class="sd">        :returns: An analog map response or None if a timeout occurs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get the current time to make sure a report is retrieved</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># if we do not have existing report results, send a Firmata</span>
        <span class="c1"># message to request one</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_QUERY</span><span class="p">)</span>
            <span class="c1"># wait for the report results to return for 4 seconds</span>
            <span class="c1"># if the timer expires, shutdown</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests and returns a Firmata capability query report</span>

<span class="sd">        :returns: A capability report in the form of a list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_QUERY</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_firmware_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the Firmata firmware version</span>

<span class="sd">        :returns: Firmata firmware version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_protocol_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method returns the major and minor values for the protocol</span>
<span class="sd">        version, i.e. 2.4</span>

<span class="sd">        :returns: Firmata protocol version</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">])</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves a pin state report for the specified pin</span>

<span class="sd">        :param pin: Pin of interest</span>

<span class="sd">        :returns: pin state report</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># place pin in a list to keep _send_sysex happy</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_QUERY</span><span class="p">,</span> <span class="p">[</span><span class="n">pin</span><span class="p">])</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
        <span class="n">pin_state_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">pin_state_report</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">get_pymata_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves the PyMata version number</span>

<span class="sd">        :returns: PyMata version number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span>

    <span class="c1"># noinspection PyIncorrectDocstring</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_delay_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NOTE: THIS METHOD MUST BE CALLED BEFORE ANY I2C REQUEST IS MADE</span>
<span class="sd">        This method initializes Firmata for I2c operations.</span>

<span class="sd">        :param read_delay_time (in microseconds): an optional parameter,</span>
<span class="sd">                                                  default is 0</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_delay_time</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">read_delay_time</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method retrieves cached i2c data to support a polling mode.</span>

<span class="sd">        :param address: I2C device address</span>

<span class="sd">        :returns: Last cached value read</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">,</span>
                               <span class="n">read_type</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method requests the read of an i2c device. Results are retrieved</span>
<span class="sd">        by a call to i2c_get_read_data(). or by callback.</span>

<span class="sd">        If a callback method is provided, when data is received from the</span>
<span class="sd">        device it will be sent to the callback method.</span>
<span class="sd">        Some devices require that transmission be restarted</span>
<span class="sd">        (e.g. MMA8452Q accelerometer).</span>
<span class="sd">        Use Constants.I2C_READ | Constants.I2C_END_TX_MASK for those cases.</span>

<span class="sd">        :param address: i2c device address</span>

<span class="sd">        :param register: register number (can be set to zero)</span>

<span class="sd">        :param number_of_bytes: number of bytes expected to be returned</span>

<span class="sd">        :param read_type: I2C_READ  or I2C_READ_CONTINUOUSLY. I2C_END_TX_MASK</span>
<span class="sd">                          may be OR&#39;ed when required</span>

<span class="sd">        :param cb: Optional callback function to report i2c data as a</span>
<span class="sd">                   result of read command</span>

<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c1"># self.i2c_map[address] = [None, cb]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="p">,</span>
                                     <span class="s1">&#39;callback_type&#39;</span><span class="p">:</span> <span class="n">cb_type</span><span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">read_type</span><span class="p">,</span> <span class="n">register</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">register</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="n">number_of_bytes</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_write_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to an i2c device.</span>

<span class="sd">        :param address: i2c device address</span>

<span class="sd">        :param args: A variable number of bytes to be sent to the device</span>
<span class="sd">                     passed in as a list</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">I2C_WRITE</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">item_lsb</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_lsb</span><span class="p">)</span>
            <span class="n">item_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_msb</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">margin</span><span class="o">=.</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Periodically send a keep alive message to the Arduino.</span>
<span class="sd">        Frequency of keep alive transmission is calculated as follows:</span>
<span class="sd">        keep_alive_sent = period - (period * margin)</span>


<span class="sd">        :param period: Time period between keepalives. Range is 0-10 seconds.</span>
<span class="sd">                       0 disables the keepalive mechanism.</span>

<span class="sd">        :param margin: Safety margin to assure keepalives are sent before</span>
<span class="sd">                    period expires. Range is 0.1 to 0.9</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
            <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
            <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)))</span>
                <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">KEEP_ALIVE</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">play_tone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">tone_command</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method will call the Tone library for the selected pin.</span>
<span class="sd">        It requires FirmataPlus to be loaded onto the arduino</span>

<span class="sd">        If the tone command is set to TONE_TONE, then the specified</span>
<span class="sd">        tone will be played.</span>

<span class="sd">        Else, if the tone command is TONE_NO_TONE, then any currently</span>
<span class="sd">        playing tone will be disabled.</span>

<span class="sd">        :param pin: Pin number</span>

<span class="sd">        :param tone_command: Either TONE_TONE, or TONE_NO_TONE</span>

<span class="sd">        :param frequency: Frequency of tone</span>

<span class="sd">        :param duration: Duration of tone in milliseconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># convert the integer values to bytes</span>
        <span class="k">if</span> <span class="n">tone_command</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">TONE_TONE</span><span class="p">:</span>
            <span class="c1"># duration is specified</span>
            <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                        <span class="n">duration</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
                        <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c1"># turn off tone</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">TONE_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">send_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a Sysex reset command to the arduino</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SYSTEM_RESET</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">servo_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span><span class="o">=</span><span class="mi">544</span><span class="p">,</span> <span class="n">max_pulse</span><span class="o">=</span><span class="mi">2400</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure a pin as a servo pin. Set pulse min, max in ms.</span>
<span class="sd">        Use this method (not set_pin_mode) to configure a pin for servo</span>
<span class="sd">        operation.</span>

<span class="sd">        :param pin: Servo Pin.</span>

<span class="sd">        :param min_pulse: Min pulse width in ms.</span>

<span class="sd">        :param max_pulse: Max pulse width in ms.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">min_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">max_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">max_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SERVO_CONFIG</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_pin_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">callback_type</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">CB_TYPE_ASYNCIO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sets the pin mode for the specified pin.</span>
<span class="sd">        For Servo, use servo_config() instead.</span>

<span class="sd">        :param pin_number: Arduino Pin Number</span>

<span class="sd">        :param pin_state: INPUT/OUTPUT/ANALOG/PWM/PULLUP - for SERVO use</span>
<span class="sd">                          servo_config()</span>

<span class="sd">        :param callback: Optional: A reference to a call back function to be</span>
<span class="sd">                         called when pin data value changes</span>

<span class="sd">        :param callback_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># There is a potential start up race condition when running pymata3.</span>
        <span class="c1"># This is a workaround for that race condition</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">):</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;set_pin_mode: callback ignored for &#39;</span>
                                         <span class="s1">&#39;pin state:&#39;</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">))</span>

        <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_state</span>

        <span class="k">if</span> <span class="n">pin_mode</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="n">pin_number</span> <span class="o">=</span> <span class="n">pin_number</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_PIN_MODE</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_mode</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_analog_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_digital_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">set_sampling_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method sends the desired sampling interval to Firmata.</span>
<span class="sd">        Note: Standard Firmata  will ignore any interval less than</span>
<span class="sd">              10 milliseconds</span>

<span class="sd">        :param interval: Integer value for desired sampling interval</span>
<span class="sd">                         in milliseconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">interval</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method attempts an orderly shutdown</span>
<span class="sd">        If any exceptions are thrown, just ignore them.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="c1"># stop all reporting - both analog and digital</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)):</span>
           <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_analog_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)):</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_digital_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is a proxy method for asyncio.sleep</span>

<span class="sd">        :param sleep_time: Sleep interval in seconds</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;sleep exception&#39;</span><span class="p">):</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                           <span class="n">ping_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the pins,ping interval and maximum distance for an HC-SR04</span>
<span class="sd">        type device.</span>
<span class="sd">        Single pin configuration may be used. To do so, set both the trigger</span>
<span class="sd">        and echo pins to the same value.</span>
<span class="sd">        Up to a maximum of 6 SONAR devices is supported</span>
<span class="sd">        If the maximum is exceeded a message is sent to the console and the</span>
<span class="sd">        request is ignored.</span>
<span class="sd">        NOTE: data is measured in centimeters</span>

<span class="sd">        :param trigger_pin: The pin number of for the trigger (transmitter).</span>

<span class="sd">        :param echo_pin: The pin number for the received echo.</span>

<span class="sd">        :param cb: optional callback function to report sonar data changes</span>

<span class="sd">        :param ping_interval: Minimum interval between pings. Lowest number</span>
<span class="sd">                              to use is 33 ms. Max is 127ms.</span>

<span class="sd">        :param max_distance: Maximum distance in cm. Max is 200.</span>

<span class="sd">        :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                        Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if there is an entry for the trigger pin in existence, just exit</span>
        <span class="k">if</span> <span class="n">trigger_pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">max_distance</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="n">max_distance_lsb</span> <span class="o">=</span> <span class="n">max_distance</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">max_distance_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_distance</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">ping_interval</span><span class="p">,</span> <span class="n">max_distance_lsb</span><span class="p">,</span>
                <span class="n">max_distance_msb</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">echo_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
        <span class="c1"># update the ping data map for this pin</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sonar_config: maximum number of devices assigned&#39;</span>
                  <span class="s1">&#39; - ignoring request&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">trigger_pin</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_data_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve Ping (HC-SR04 type) data. The data is presented as a</span>
<span class="sd">        dictionary.</span>
<span class="sd">        The &#39;key&#39; is the trigger pin specified in sonar_config()</span>
<span class="sd">        and the &#39;data&#39; is the current measured distance (in centimeters)</span>
<span class="sd">        for that pin. If there is no data, the value is set to None.</span>

<span class="sd">        :param trigger_pin: key into sonar data map</span>

<span class="sd">        :returns: active_sonar_map</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_per_revolution</span><span class="p">,</span> <span class="n">stepper_pins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure stepper motor prior to operation.</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param steps_per_revolution: number of steps per motor revolution</span>

<span class="sd">        :param stepper_pins: a list of control pin numbers - either 4 or 2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_CONFIGURE</span><span class="p">,</span> <span class="n">steps_per_revolution</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="p">(</span><span class="n">steps_per_revolution</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">)):</span>
            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">])</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_speed</span><span class="p">,</span> <span class="n">number_of_steps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Move a stepper motor for the number of steps at the specified speed</span>
<span class="sd">        This is a FirmataPlus feature.</span>

<span class="sd">        :param motor_speed: 21 bits of data to set motor speed</span>

<span class="sd">        :param number_of_steps: 14 bits for number of steps &amp; direction</span>
<span class="sd">                                positive is forward, negative is reverse</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">number_of_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">abs_number_of_steps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number_of_steps</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_STEP</span><span class="p">,</span> <span class="n">motor_speed</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                <span class="n">abs_number_of_steps</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">abs_number_of_steps</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">direction</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_arduino_report_dispatcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private method.</span>
<span class="sd">        It continually accepts and interprets data coming from Firmata,and then</span>
<span class="sd">        dispatches the correct handler to process the data.</span>

<span class="sd">        :returns: This method never returns</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># sysex commands are assembled into this list for processing</span>
        <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="c1"># if this is a SYSEX command, then assemble the entire</span>
                <span class="c1"># command process it</span>
                <span class="k">if</span> <span class="n">next_command_byte</span> <span class="o">==</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">next_command_byte</span> <span class="o">!=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">:</span>
                        <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                        <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                        <span class="n">sysex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">sysex</span><span class="p">[</span><span class="mi">0</span><span class="p">]](</span><span class="n">sysex</span><span class="p">)</span>
                    <span class="n">sysex</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                <span class="c1"># if this is an analog message, process it.</span>
                <span class="k">elif</span> <span class="mh">0xE0</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;=</span> <span class="mh">0xEF</span><span class="p">:</span>
                    <span class="c1"># analog message</span>
                    <span class="c1"># assemble the entire analog message in command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># get the pin number for the message</span>
                    <span class="n">pin</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
                    <span class="c1"># get the next 2 bytes for the command</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># process the analog message</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c1"># handle the digital message</span>
                <span class="k">elif</span> <span class="mh">0x90</span> <span class="o">&lt;=</span> <span class="n">next_command_byte</span> <span class="o">&lt;=</span> <span class="mh">0x9F</span><span class="p">:</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">port</span> <span class="o">=</span> <span class="n">next_command_byte</span> <span class="o">&amp;</span> <span class="mh">0x0f</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
                    <span class="n">command</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for_data</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
                <span class="c1"># handle all other messages by looking them up in the</span>
                <span class="c1"># command dictionary</span>
                <span class="k">elif</span> <span class="n">next_command_byte</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span><span class="p">[</span><span class="n">next_command_byte</span><span class="p">]()</span>
                    <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># we need to yield back to the loop</span>
                    <span class="c1"># await asyncio.sleep(self.sleep_tune)</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span>


    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Firmata message handlers</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_mapping_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for the analog mapping response message.</span>

<span class="sd">        :param data: response data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">]</span> <span class="o">=</span> \
            <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_analog_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for analog messages.</span>

<span class="sd">        :param data: message data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>

        <span class="c1"># only report when there is a change in value</span>
        <span class="n">differential</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">value</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">differential</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_report_differential</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span> <span class="o">=</span> <span class="n">time_stamp</span>

            <span class="c1"># append pin number, pin value, and pin type to return value and return as a list</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_capability_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for capability report responses.</span>

<span class="sd">        :param data: capability report</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_digital_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is a message handler for Digital Messages.</span>

<span class="sd">        :param data: digital message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">port_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span> \
                    <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">port</span> <span class="o">*</span> <span class="mi">8</span>
        <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">pin</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">))):</span>
            <span class="c1"># get pin value</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">port_data</span> <span class="o">&amp;</span> <span class="mh">0x01</span>

            <span class="c1"># set the current value in the pin structure</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">time_stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span> <span class="o">=</span> <span class="n">time_stamp</span>

            <span class="c1"># append pin number, pin value, and pin type to return value and return as a list</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">,</span> <span class="n">time_stamp</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># self.digital_pins[pin].cb(data)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">message</span><span class="p">)</span>

            <span class="n">port_data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_encoder_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles encoder data messages.</span>

<span class="sd">        :param data: encoder data</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>
        <span class="c1"># set value so that it shows positive and negative values</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">-=</span> <span class="mi">16384</span>
        <span class="c1"># if this value is different that is what is already in the</span>
        <span class="c1"># table store it and check for callback</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">:</span>
                <span class="c1"># self.digital_pins[pin].cb([pin, val])</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># self.digital_pins[pin].cb(data)</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

    <span class="c1"># noinspection PyDictCreation</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_i2c_reply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles replies to i2c_read requests. It stores the data</span>
<span class="sd">        for each i2c device address in a dictionary called i2c_map.</span>
<span class="sd">        The data may be retrieved via a polling call to i2c_get_read_data().</span>
<span class="sd">        It a callback was specified in pymata.i2c_read, the raw data is sent</span>
<span class="sd">        through the callback</span>

<span class="sd">        :param data: raw data returned from i2c device</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># remove the start and end sysex commands from the data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># reassemble the data from the firmata 2 byte format</span>
        <span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>

        <span class="c1"># if we have an entry in the i2c_map, proceed</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
            <span class="c1"># get 2 bytes, combine them and append to reply data list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">combined_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span>
                <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined_data</span><span class="p">)</span>

            <span class="c1"># place the data in the i2c map without storing the address byte or</span>
            <span class="c1">#  register byte (returned data only)</span>
            <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
            <span class="n">map_entry</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reply_data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_entry</span>
            <span class="n">cb</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span><span class="p">)</span>
            <span class="n">cb_type</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;callback_type&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cb</span><span class="p">:</span>
                <span class="c1"># send everything, including address and register bytes back</span>
                <span class="c1"># to caller</span>
                <span class="k">if</span> <span class="n">cb_type</span><span class="p">:</span>
                    <span class="n">await</span> <span class="n">cb</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                    <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">reply_data</span><span class="p">)</span>
                <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_pin_state_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It handles pin state query response messages.</span>

<span class="sd">        :param data: Pin state message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_firmware</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method handles the sysex &#39;report firmware&#39; command sent by</span>
<span class="sd">        Firmata (0x79).</span>
<span class="sd">        It assembles the firmware version by concatenating the major and</span>
<span class="sd">         minor version number components and</span>
<span class="sd">        the firmware identifier into a string.</span>
<span class="sd">        e.g. &quot;2.3 StandardFirmata.ino&quot;</span>

<span class="sd">        :param sysex_data: Sysex data sent from Firmata</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># first byte after command is major number</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>

        <span class="c1"># next byte is minor number</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="c1"># append a dot to major number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>

        <span class="c1"># append minor number</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="c1"># add a space after the major and minor numbers</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39; &#39;</span>

        <span class="c1"># slice the identifier - from the first byte after the minor</span>
        <span class="c1">#  number up until, but not including the END_SYSEX byte</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">sysex_data</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">firmware_name_iterator</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="c1"># convert each element from two 7-bit bytes into characters, then add each</span>
        <span class="c1"># character to the version string</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">firmware_name_iterator</span><span class="p">:</span>
            <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">e</span> <span class="o">+</span> <span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">firmware_name_iterator</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">))</span>

        <span class="c1"># store the value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_report_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        This method reads the following 2 bytes after the report version</span>
<span class="sd">        command (0xF9 - non sysex).</span>
<span class="sd">        The first byte is the major number and the second byte is the</span>
<span class="sd">        minor number.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get next two bytes</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">major</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">version_string</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">minor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">]</span> <span class="o">=</span> <span class="n">version_string</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_sonar_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method handles the incoming sonar data message and stores</span>
<span class="sd">        the data in the response table.</span>

<span class="sd">        :param data: Message data from Firmata</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># strip off sysex start and end</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pin_number</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">MSB</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
                  <span class="n">data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">LSB</span><span class="p">])</span>
        <span class="n">reply_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c1"># check if value changed since last reading</span>
            <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">val</span><span class="p">:</span>
                <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>
                <span class="c1"># Do a callback if one is specified in the table</span>
                <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># if this is an asyncio callback type</span>
                    <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
                    <span class="n">reply_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">await</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="n">reply_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># sonar_pin_entry[0]([pin_number, val])</span>
                        <span class="n">loop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span>
                        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reply_data</span><span class="p">)</span>
        <span class="c1"># update the data in the table with latest value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span>

        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="n">async</span> <span class="k">def</span> <span class="nf">_string_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private message handler method.</span>
<span class="sd">        It is the message handler for String data messages that will be</span>
<span class="sd">        printed to the console.</span>
<span class="sd">        :param data:  message</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reply</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">reply_data</span> <span class="o">=</span> <span class="n">x</span>
            <span class="k">if</span> <span class="n">reply_data</span><span class="p">:</span>
                <span class="n">reply</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">reply_data</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>

    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    utilities</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># noinspection PyMethodMayBeStatic</span>
    <span class="k">def</span> <span class="nf">_format_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method formats a capability report if the user wishes to</span>
<span class="sd">        send it to the console.</span>
<span class="sd">        If log_output = True, no output is generated</span>

<span class="sd">        :param data: Capability report</span>

<span class="sd">        :returns: None</span>
<span class="sd">        &quot;&quot;&quot;</span>




        <span class="n">pin_modes</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;Digital_Input&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;Digital_Output&#39;</span><span class="p">,</span>
                     <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;Analog&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span> <span class="s1">&#39;PWM&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">:</span> <span class="s1">&#39;Servo&#39;</span><span class="p">,</span>
                     <span class="mi">5</span><span class="p">:</span> <span class="s1">&#39;Shift&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">:</span> <span class="s1">&#39;I2C&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">:</span> <span class="s1">&#39;One Wire&#39;</span><span class="p">,</span>
                     <span class="mi">8</span><span class="p">:</span> <span class="s1">&#39;Stepper&#39;</span><span class="p">,</span> <span class="mi">9</span><span class="p">:</span> <span class="s1">&#39;Encoder&#39;</span><span class="p">}</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Capability Report&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-----------------</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># get index of next end marker</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Pin&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin</span><span class="p">),</span> <span class="s1">&#39;:&#39;</span><span class="p">))</span>
            <span class="k">while</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">127</span><span class="p">:</span>
                <span class="n">mode_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_modes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">])</span>
                <span class="n">mode_str</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pin_mode</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">bits</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">x</span><span class="p">]</span>
                <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{:&gt;5}{}{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;  &#39;</span><span class="p">,</span> <span class="n">mode_str</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="n">bits</span><span class="p">))</span>
                <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">pin</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        The method sends a non-sysex command to Firmata.</span>

<span class="sd">        :param command:  command data</span>

<span class="sd">        :returns: length of data sent</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">send_message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">command</span><span class="p">:</span>
            <span class="n">send_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">send_message</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;cannot send command&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_send_sysex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sysex_command</span><span class="p">,</span> <span class="n">sysex_data</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method sends a sysex command to Firmata.</span>

<span class="sd">        :param sysex_command: sysex command</span>

<span class="sd">        :param sysex_data: data for command</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sysex_data</span><span class="p">:</span>
            <span class="n">sysex_data</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># convert the message command and data to characters</span>
        <span class="n">sysex_message</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">START_SYSEX</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">sysex_command</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sysex_data</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">sysex_data</span><span class="p">:</span>
                <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">sysex_message</span> <span class="o">+=</span> <span class="nb">chr</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">END_SYSEX</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">sysex_message</span><span class="p">:</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">async</span> <span class="k">def</span> <span class="nf">_wait_for_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_command</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This is a private utility method.</span>
<span class="sd">        This method accumulates the requested number of bytes and</span>
<span class="sd">        then returns the full command</span>

<span class="sd">        :param current_command:  command id</span>

<span class="sd">        :param number_of_bytes:  how many bytes to wait for</span>

<span class="sd">        :returns: command</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="n">number_of_bytes</span><span class="p">:</span>
            <span class="n">next_command_byte</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">current_command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">next_command_byte</span><span class="p">)</span>
            <span class="n">number_of_bytes</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">current_command</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#pymata_express.pymata_express.PymataExpress">PymataExpress</a></li>
          <li>builtins.object</li>
          </ul>
          <h3>Static methods</h3>
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, com_port=None, baud_rate=115200, arduino_instance_id=1, arduino_wait=4, sleep_tune=0.0001, autostart=True, analog_report_differential=1)</p>
    </div>
    

    
  
    <div class="desc"><p>If you are using the Firmata Express Arduino sketch,
and have a single Arduino connected to your computer,
then you may accept all the default values.</p>
<p>If you are using some other Firmata sketch, then
you must specify both the com_port and baudrate.</p>
<p>:param com_port: e.g. COM3 or /dev/ttyACM0.</p>
<p>:param baud_rate: Match this to the Firmata sketch in use.</p>
<p>:param arduino_instance_id: If you are using the Firmata
                            Express sketch, match this
                            value to that in the sketch.</p>
<p>:param arduino_wait: Amount of time to wait for an Arduino to
                     fully reset itself.</p>
<p>:param sleep_tune: A tuning parameter used by PymataExpressSerial</p>
<p>:param autostart: If you wish to call the start method within
                  your application, then set this to False.</p>
<p>:param analog_report_differential: When comparing the currently
                                   reported analog value with the
                                   previous, this differential must
                                   be met for a the callback method
                                   to be called.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.__init__', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">com_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">baud_rate</span><span class="o">=</span><span class="mi">115200</span><span class="p">,</span>
             <span class="n">arduino_instance_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">arduino_wait</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
             <span class="n">sleep_tune</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">autostart</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
             <span class="n">analog_report_differential</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If you are using the Firmata Express Arduino sketch,</span>
<span class="sd">    and have a single Arduino connected to your computer,</span>
<span class="sd">    then you may accept all the default values.</span>
<span class="sd">    If you are using some other Firmata sketch, then</span>
<span class="sd">    you must specify both the com_port and baudrate.</span>
<span class="sd">    :param com_port: e.g. COM3 or /dev/ttyACM0.</span>
<span class="sd">    :param baud_rate: Match this to the Firmata sketch in use.</span>
<span class="sd">    :param arduino_instance_id: If you are using the Firmata</span>
<span class="sd">                                Express sketch, match this</span>
<span class="sd">                                value to that in the sketch.</span>
<span class="sd">    :param arduino_wait: Amount of time to wait for an Arduino to</span>
<span class="sd">                         fully reset itself.</span>
<span class="sd">    :param sleep_tune: A tuning parameter used by PymataExpressSerial</span>
<span class="sd">    :param autostart: If you wish to call the start method within</span>
<span class="sd">                      your application, then set this to False.</span>
<span class="sd">    :param analog_report_differential: When comparing the currently</span>
<span class="sd">                                       reported analog value with the</span>
<span class="sd">                                       previous, this differential must</span>
<span class="sd">                                       be met for a the callback method</span>
<span class="sd">                                       to be called.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check to make sure that Python interpreter is version 3.7 or greater</span>
    <span class="n">python_version</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span>
    <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">python_version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span>
                <span class="s2">&quot;ERROR: Python 3.7 or greater is required for use of this program.&quot;</span><span class="p">)</span>
    <span class="c1"># save input parameters</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span> <span class="o">=</span> <span class="n">com_port</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">baud_rate</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">arduino_instance_id</span> <span class="o">=</span> <span class="n">arduino_instance_id</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">arduino_wait</span> <span class="o">=</span> <span class="n">arduino_wait</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span> <span class="o">=</span> <span class="n">sleep_tune</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">autostart</span> <span class="o">=</span> <span class="n">autostart</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analog_report_differential</span> <span class="o">=</span> <span class="n">analog_report_differential</span>
    <span class="c1"># a list of PinData objects - one for each pin segregated by pin type</span>
    <span class="c1"># see pin_data.py</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># serial port in use</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># An i2c_map entry consists of a device i2c address as the key, and</span>
    <span class="c1">#  the value of the key consists of a dictionary containing 3 entries.</span>
    <span class="c1">#  The first entry. &#39;value&#39; contains the last value reported, and</span>
    <span class="c1"># the second, &#39;callback&#39; contains a reference to a callback function.</span>
    <span class="c1"># the third, callback_type contains the callback type selector</span>
    <span class="c1">#  (None = Direct, 1 = await)</span>
    <span class="c1"># For example:</span>
    <span class="c1"># {12345: {&#39;value&#39;: 23, &#39;callback&#39;: None, &#39;callback_type: None}}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># the active_sonar_map maps the sonar trigger pin number (the key)</span>
    <span class="c1"># to the current data value returned</span>
    <span class="c1"># if a callback was specified, it is stored in the map as well.</span>
    <span class="c1"># an entry in the map consists of:</span>
    <span class="c1">#   pin: [callback,, callback_type, [current_data_returned]]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># keep alive variables</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># first analog pin number</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># asyncio loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="c1"># generic asyncio task holder</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># flag to indicate we are in shutdown mode</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="c1"># this dictionary for mapping incoming Firmata message types to</span>
    <span class="c1"># handlers for the messages</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">command_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_report_version</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_report_firmware</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_capability_response</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_analog_mapping_response</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_pin_state_response</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_string_data</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_analog_message</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_digital_message</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REPLY</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_i2c_reply</span><span class="p">,</span>
                               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_DATA</span><span class="p">:</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">_sonar_data</span><span class="p">,}</span>
    <span class="c1"># report query results are stored in this dictionary</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STRING_DATA</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                             <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
                             <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;pymata_aio Version &#39;</span> <span class="o">+</span>
                          <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span><span class="p">,</span>
                          <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">Copyright (c) 2018-2019 Alan Yorinks All &#39;</span>
                          <span class="s1">&#39;rights reserved.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
        <span class="c1"># user did not specify a com_port</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_find_arduino</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># com_port specified - set com_port and baud rate</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_manual_open</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Arduino found and connected to &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">com_port</span><span class="p">))</span>
    <span class="c1"># no com_port found - raise a runtime exception</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No Arduino Found or User Aborted Program&#39;</span><span class="p">)</span>
    <span class="c1"># start the application</span>
    <span class="k">if</span> <span class="n">autostart</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.analog_read">
    <p>def <span class="ident">analog_read</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Retrieve the last data update for the specified analog pin.</p>
<p>:param pin: Analog pin number (ex. A2 is specified as 2)</p>
<p>:returns: A tuple of last value change and the time that it occurred</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.analog_read', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.analog_read" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">analog_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the last data update for the specified analog pin.</span>
<span class="sd">    :param pin: Analog pin number (ex. A2 is specified as 2)</span>
<span class="sd">    :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.analog_write">
    <p>def <span class="ident">analog_write</span>(</p><p>self, pin, value)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the selected pin to the specified value.</p>
<p>:param pin: PWM pin number</p>
<p>:param value: Pin value (0 - 0x4000)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.analog_write', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.analog_write" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">analog_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the selected pin to the specified value.</span>
<span class="sd">    :param pin: PWM pin number</span>
<span class="sd">    :param value: Pin value (0 - 0x4000)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MESSAGE</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                   <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">extended_analog</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.digital_pin_write">
    <p>def <span class="ident">digital_pin_write</span>(</p><p>self, pin, value)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the specified pin to the specified value directly without port manipulation.</p>
<p>:param pin: pin number</p>
<p>:param value: pin value</p>
<p>:returns: No return value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.digital_pin_write', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.digital_pin_write" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">digital_pin_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the specified pin to the specified value directly without port manipulation.</span>
<span class="sd">    :param pin: pin number</span>
<span class="sd">    :param value: pin value</span>
<span class="sd">    :returns: No return value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_DIGITAL_PIN_VALUE</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.digital_read">
    <p>def <span class="ident">digital_read</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Retrieve the last data update for the specified digital pin.</p>
<p>:param pin: Digital pin number</p>
<p>:returns: A tuple of last value change and the time that it occurred</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.digital_read', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.digital_read" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">digital_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the last data update for the specified digital pin.</span>
<span class="sd">    :param pin: Digital pin number</span>
<span class="sd">    :returns: A tuple of last value change and the time that it occurred</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">current_value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">]</span><span class="o">.</span><span class="n">event_time</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.digital_write">
    <p>def <span class="ident">digital_write</span>(</p><p>self, pin, value)</p>
    </div>
    

    
  
    <div class="desc"><p>Set the specified pin to the specified value.</p>
<p>:param pin: pin number</p>
<p>:param value: pin value</p>
<p>:returns: No return value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.digital_write', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.digital_write" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">digital_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set the specified pin to the specified value.</span>
<span class="sd">    :param pin: pin number</span>
<span class="sd">    :param value: pin value</span>
<span class="sd">    :returns: No return value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The command value is not a fixed value, but needs to be calculated</span>
    <span class="c1"># using the pin&#39;s port number</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">calculated_command</span> <span class="o">=</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_MESSAGE</span> <span class="o">+</span> <span class="n">port</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">pin</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span>
    <span class="c1"># Calculate the value for the pin&#39;s position in the port mask</span>
    <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">|=</span> <span class="n">mask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span>
    <span class="c1"># Assemble the command</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">(</span><span class="n">calculated_command</span><span class="p">,</span>
               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
               <span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">DIGITAL_OUTPUT_PORT_PINS</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.disable_analog_reporting">
    <p>def <span class="ident">disable_analog_reporting</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Disables analog reporting for a single analog pin.</p>
<p>:param pin: Analog pin number. For example for A0, the number is 0.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.disable_analog_reporting', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.disable_analog_reporting" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">disable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disables analog reporting for a single analog pin.</span>
<span class="sd">    :param pin: Analog pin number. For example for A0, the number is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.disable_digital_reporting">
    <p>def <span class="ident">disable_digital_reporting</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Disables digital reporting. By turning reporting off for this pin,
Reporting is disabled for all 8 bits in the "port"</p>
<p>:param pin: Pin and all pins for this port</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.disable_digital_reporting', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.disable_digital_reporting" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">disable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Disables digital reporting. By turning reporting off for this pin,</span>
<span class="sd">    Reporting is disabled for all 8 bits in the &quot;port&quot;</span>
<span class="sd">    :param pin: Pin and all pins for this port</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_DISABLE</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.enable_analog_reporting">
    <p>def <span class="ident">enable_analog_reporting</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Enables analog reporting. By turning reporting on for a single pin,</p>
<p>:param pin: Analog pin number. For example for A0, the number is 0.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.enable_analog_reporting', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.enable_analog_reporting" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">enable_analog_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables analog reporting. By turning reporting on for a single pin,</span>
<span class="sd">    :param pin: Analog pin number. For example for A0, the number is 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_ANALOG</span> <span class="o">+</span> <span class="n">pin</span><span class="p">,</span>
               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.enable_digital_reporting">
    <p>def <span class="ident">enable_digital_reporting</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Enables digital reporting. By turning reporting on for all 8 bits
in the "port" - this is part of Firmata's protocol specification.</p>
<p>:param pin: Pin and all pins for this port</p>
<p>:returns: No return value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.enable_digital_reporting', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.enable_digital_reporting" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">enable_digital_reporting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enables digital reporting. By turning reporting on for all 8 bits</span>
<span class="sd">    in the &quot;port&quot; - this is part of Firmata&#39;s protocol specification.</span>
<span class="sd">    :param pin: Pin and all pins for this port</span>
<span class="sd">    :returns: No return value</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="n">port</span> <span class="o">=</span> <span class="n">pin</span> <span class="o">//</span> <span class="mi">8</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_DIGITAL</span> <span class="o">+</span> <span class="n">port</span><span class="p">,</span>
               <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORTING_ENABLE</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.extended_analog">
    <p>def <span class="ident">extended_analog</span>(</p><p>self, pin, data)</p>
    </div>
    

    
  
    <div class="desc"><p>This method will send an extended-data analog write command to the
selected pin.</p>
<p>:param pin: 0 - 127</p>
<p>:param data: 0 - 0xfffff</p>
<p>:returns: No return value</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.extended_analog', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.extended_analog" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">extended_analog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will send an extended-data analog write command to the</span>
<span class="sd">    selected pin.</span>
<span class="sd">    :param pin: 0 - 127</span>
<span class="sd">    :param data: 0 - 0xfffff</span>
<span class="sd">    :returns: No return value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">analog_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">EXTENDED_ANALOG</span><span class="p">,</span> <span class="n">analog_data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_analog_map">
    <p>def <span class="ident">get_analog_map</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method requests a Firmata analog map query and returns the results.</p>
<p>:returns: An analog map response or None if a timeout occurs</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_analog_map', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_analog_map" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_analog_map</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method requests a Firmata analog map query and returns the results.</span>
<span class="sd">    :returns: An analog map response or None if a timeout occurs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the current time to make sure a report is retrieved</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># if we do not have existing report results, send a Firmata</span>
    <span class="c1"># message to request one</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_QUERY</span><span class="p">)</span>
        <span class="c1"># wait for the report results to return for 4 seconds</span>
        <span class="c1"># if the timer expires, shutdown</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">ANALOG_MAPPING_RESPONSE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_capability_report">
    <p>def <span class="ident">get_capability_report</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method requests and returns a Firmata capability query report</p>
<p>:returns: A capability report in the form of a list</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_capability_report', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_capability_report" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_capability_report</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method requests and returns a Firmata capability query report</span>
<span class="sd">    :returns: A capability report in the form of a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_QUERY</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">CAPABILITY_RESPONSE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_firmware_version">
    <p>def <span class="ident">get_firmware_version</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method retrieves the Firmata firmware version</p>
<p>:returns: Firmata firmware version</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_firmware_version', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_firmware_version" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_firmware_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method retrieves the Firmata firmware version</span>
<span class="sd">    :returns: Firmata firmware version</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">elapsed_time</span> <span class="o">-</span> <span class="n">current_time</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_FIRMWARE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_pin_state">
    <p>def <span class="ident">get_pin_state</span>(</p><p>self, pin)</p>
    </div>
    

    
  
    <div class="desc"><p>This method retrieves a pin state report for the specified pin</p>
<p>:param pin: Pin of interest</p>
<p>:returns: pin state report</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_pin_state', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_pin_state" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_pin_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method retrieves a pin state report for the specified pin</span>
<span class="sd">    :param pin: Pin of interest</span>
<span class="sd">    :returns: pin state report</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># place pin in a list to keep _send_sysex happy</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_QUERY</span><span class="p">,</span> <span class="p">[</span><span class="n">pin</span><span class="p">])</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
    <span class="n">pin_state_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PIN_STATE_RESPONSE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">pin_state_report</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_protocol_version">
    <p>def <span class="ident">get_protocol_version</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method returns the major and minor values for the protocol
version, i.e. 2.4</p>
<p>:returns: Firmata protocol version</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_protocol_version', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_protocol_version" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_protocol_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method returns the major and minor values for the protocol</span>
<span class="sd">    version, i.e. 2.4</span>
<span class="sd">    :returns: Firmata protocol version</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">])</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleep_tune</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_reply_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">REPORT_VERSION</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.get_pymata_version">
    <p>def <span class="ident">get_pymata_version</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method retrieves the PyMata version number</p>
<p>:returns: PyMata version number.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.get_pymata_version', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.get_pymata_version" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">get_pymata_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method retrieves the PyMata version number</span>
<span class="sd">    :returns: PyMata version number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PrivateConstants</span><span class="o">.</span><span class="n">PYMATA_EXPRESS_VERSION</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.i2c_config">
    <p>def <span class="ident">i2c_config</span>(</p><p>self, read_delay_time=0)</p>
    </div>
    

    
  
    <div class="desc"><p>NOTE: THIS METHOD MUST BE CALLED BEFORE ANY I2C REQUEST IS MADE
This method initializes Firmata for I2c operations.</p>
<p>:param read_delay_time (in microseconds): an optional parameter,
                                          default is 0</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.i2c_config', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.i2c_config" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_delay_time</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NOTE: THIS METHOD MUST BE CALLED BEFORE ANY I2C REQUEST IS MADE</span>
<span class="sd">    This method initializes Firmata for I2c operations.</span>
<span class="sd">    :param read_delay_time (in microseconds): an optional parameter,</span>
<span class="sd">                                              default is 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">read_delay_time</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">read_delay_time</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.i2c_read_data">
    <p>def <span class="ident">i2c_read_data</span>(</p><p>self, address)</p>
    </div>
    

    
  
    <div class="desc"><p>This method retrieves cached i2c data to support a polling mode.</p>
<p>:param address: I2C device address</p>
<p>:returns: Last cached value read</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.i2c_read_data', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.i2c_read_data" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method retrieves cached i2c data to support a polling mode.</span>
<span class="sd">    :param address: I2C device address</span>
<span class="sd">    :returns: Last cached value read</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
        <span class="n">map_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">map_entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.i2c_read_request">
    <p>def <span class="ident">i2c_read_request</span>(</p><p>self, address, register, number_of_bytes, read_type, cb=None, cb_type=None)</p>
    </div>
    

    
  
    <div class="desc"><p>This method requests the read of an i2c device. Results are retrieved
by a call to i2c_get_read_data(). or by callback.</p>
<p>If a callback method is provided, when data is received from the
device it will be sent to the callback method.
Some devices require that transmission be restarted
(e.g. MMA8452Q accelerometer).
Use Constants.I2C_READ | Constants.I2C_END_TX_MASK for those cases.</p>
<p>:param address: i2c device address</p>
<p>:param register: register number (can be set to zero)</p>
<p>:param number_of_bytes: number of bytes expected to be returned</p>
<p>:param read_type: I2C_READ  or I2C_READ_CONTINUOUSLY. I2C_END_TX_MASK
                  may be OR'ed when required</p>
<p>:param cb: Optional callback function to report i2c data as a
           result of read command</p>
<p>:param cb_type: Constants.CB_TYPE_DIRECT = direct call or
                Constants.CB_TYPE_ASYNCIO = asyncio coroutine</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.i2c_read_request', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.i2c_read_request" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_read_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">register</span><span class="p">,</span> <span class="n">number_of_bytes</span><span class="p">,</span>
                           <span class="n">read_type</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method requests the read of an i2c device. Results are retrieved</span>
<span class="sd">    by a call to i2c_get_read_data(). or by callback.</span>
<span class="sd">    If a callback method is provided, when data is received from the</span>
<span class="sd">    device it will be sent to the callback method.</span>
<span class="sd">    Some devices require that transmission be restarted</span>
<span class="sd">    (e.g. MMA8452Q accelerometer).</span>
<span class="sd">    Use Constants.I2C_READ | Constants.I2C_END_TX_MASK for those cases.</span>
<span class="sd">    :param address: i2c device address</span>
<span class="sd">    :param register: register number (can be set to zero)</span>
<span class="sd">    :param number_of_bytes: number of bytes expected to be returned</span>
<span class="sd">    :param read_type: I2C_READ  or I2C_READ_CONTINUOUSLY. I2C_END_TX_MASK</span>
<span class="sd">                      may be OR&#39;ed when required</span>
<span class="sd">    :param cb: Optional callback function to report i2c data as a</span>
<span class="sd">               result of read command</span>
<span class="sd">    :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                    Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">:</span>
        <span class="c1"># self.i2c_map[address] = [None, cb]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2c_map</span><span class="p">[</span><span class="n">address</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s1">&#39;callback&#39;</span><span class="p">:</span> <span class="n">cb</span><span class="p">,</span>
                                 <span class="s1">&#39;callback_type&#39;</span><span class="p">:</span> <span class="n">cb_type</span><span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">read_type</span><span class="p">,</span> <span class="n">register</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">register</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
            <span class="n">number_of_bytes</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">number_of_bytes</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.i2c_write_request">
    <p>def <span class="ident">i2c_write_request</span>(</p><p>self, address, args)</p>
    </div>
    

    
  
    <div class="desc"><p>Write data to an i2c device.</p>
<p>:param address: i2c device address</p>
<p>:param args: A variable number of bytes to be sent to the device
             passed in as a list</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.i2c_write_request', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.i2c_write_request" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">i2c_write_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write data to an i2c device.</span>
<span class="sd">    :param address: i2c device address</span>
<span class="sd">    :param args: A variable number of bytes to be sent to the device</span>
<span class="sd">                 passed in as a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">address</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">I2C_WRITE</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">item_lsb</span> <span class="o">=</span> <span class="n">item</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_lsb</span><span class="p">)</span>
        <span class="n">item_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_msb</span><span class="p">)</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">I2C_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.keep_alive">
    <p>def <span class="ident">keep_alive</span>(</p><p>self, period=1, margin=0.3)</p>
    </div>
    

    
  
    <div class="desc"><p>Periodically send a keep alive message to the Arduino.
Frequency of keep alive transmission is calculated as follows:
keep_alive_sent = period - (period * margin)</p>
<p>:param period: Time period between keepalives. Range is 0-10 seconds.
               0 disables the keepalive mechanism.</p>
<p>:param margin: Safety margin to assure keepalives are sent before
            period expires. Range is 0.1 to 0.9</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.keep_alive', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.keep_alive" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">keep_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">margin</span><span class="o">=.</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Periodically send a keep alive message to the Arduino.</span>
<span class="sd">    Frequency of keep alive transmission is calculated as follows:</span>
<span class="sd">    keep_alive_sent = period - (period * margin)</span>
<span class="sd">    :param period: Time period between keepalives. Range is 0-10 seconds.</span>
<span class="sd">                   0 disables the keepalive mechanism.</span>
<span class="sd">    :param margin: Safety margin to assure keepalives are sent before</span>
<span class="sd">                period expires. Range is 0.1 to 0.9</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">period</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">period</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">period</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span>
    <span class="k">if</span> <span class="n">margin</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">margin</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
        <span class="n">margin</span> <span class="o">=</span> <span class="o">.</span><span class="mi">9</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">margin</span> <span class="o">=</span> <span class="n">margin</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span> <span class="o">=</span> <span class="p">[</span><span class="n">period</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">period</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">period</span><span class="p">:</span>
            <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="p">(</span><span class="n">period</span> <span class="o">*</span> <span class="n">margin</span><span class="p">)))</span>
            <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">KEEP_ALIVE</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">keep_alive_interval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">break</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.play_tone">
    <p>def <span class="ident">play_tone</span>(</p><p>self, pin, tone_command, frequency, duration)</p>
    </div>
    

    
  
    <div class="desc"><p>This method will call the Tone library for the selected pin.
It requires FirmataPlus to be loaded onto the arduino</p>
<p>If the tone command is set to TONE_TONE, then the specified
tone will be played.</p>
<p>Else, if the tone command is TONE_NO_TONE, then any currently
playing tone will be disabled.</p>
<p>:param pin: Pin number</p>
<p>:param tone_command: Either TONE_TONE, or TONE_NO_TONE</p>
<p>:param frequency: Frequency of tone</p>
<p>:param duration: Duration of tone in milliseconds</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.play_tone', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.play_tone" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">play_tone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">tone_command</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">duration</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method will call the Tone library for the selected pin.</span>
<span class="sd">    It requires FirmataPlus to be loaded onto the arduino</span>
<span class="sd">    If the tone command is set to TONE_TONE, then the specified</span>
<span class="sd">    tone will be played.</span>
<span class="sd">    Else, if the tone command is TONE_NO_TONE, then any currently</span>
<span class="sd">    playing tone will be disabled.</span>
<span class="sd">    :param pin: Pin number</span>
<span class="sd">    :param tone_command: Either TONE_TONE, or TONE_NO_TONE</span>
<span class="sd">    :param frequency: Frequency of tone</span>
<span class="sd">    :param duration: Duration of tone in milliseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert the integer values to bytes</span>
    <span class="k">if</span> <span class="n">tone_command</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">TONE_TONE</span><span class="p">:</span>
        <span class="c1"># duration is specified</span>
        <span class="k">if</span> <span class="n">duration</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
                    <span class="n">duration</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span>
                    <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="c1"># turn off tone</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">tone_command</span><span class="p">,</span> <span class="n">pin</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">TONE_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.send_reset">
    <p>def <span class="ident">send_reset</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Send a Sysex reset command to the arduino</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.send_reset', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.send_reset" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">send_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Send a Sysex reset command to the arduino</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">([</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SYSTEM_RESET</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.servo_config">
    <p>def <span class="ident">servo_config</span>(</p><p>self, pin, min_pulse=544, max_pulse=2400)</p>
    </div>
    

    
  
    <div class="desc"><p>Configure a pin as a servo pin. Set pulse min, max in ms.
Use this method (not set_pin_mode) to configure a pin for servo
operation.</p>
<p>:param pin: Servo Pin.</p>
<p>:param min_pulse: Min pulse width in ms.</p>
<p>:param max_pulse: Max pulse width in ms.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.servo_config', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.servo_config" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">servo_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span><span class="o">=</span><span class="mi">544</span><span class="p">,</span> <span class="n">max_pulse</span><span class="o">=</span><span class="mi">2400</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure a pin as a servo pin. Set pulse min, max in ms.</span>
<span class="sd">    Use this method (not set_pin_mode) to configure a pin for servo</span>
<span class="sd">    operation.</span>
<span class="sd">    :param pin: Servo Pin.</span>
<span class="sd">    :param min_pulse: Min pulse width in ms.</span>
<span class="sd">    :param max_pulse: Max pulse width in ms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">min_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">min_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">max_pulse</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
               <span class="p">(</span><span class="n">max_pulse</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SERVO_CONFIG</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.set_pin_mode">
    <p>def <span class="ident">set_pin_mode</span>(</p><p>self, pin_number, pin_state, callback=None, callback_type=1)</p>
    </div>
    

    
  
    <div class="desc"><p>This method sets the pin mode for the specified pin.
For Servo, use servo_config() instead.</p>
<p>:param pin_number: Arduino Pin Number</p>
<p>:param pin_state: INPUT/OUTPUT/ANALOG/PWM/PULLUP - for SERVO use
                  servo_config()</p>
<p>:param callback: Optional: A reference to a call back function to be
                 called when pin data value changes</p>
<p>:param callback_type: Constants.CB_TYPE_DIRECT = direct call or
                Constants.CB_TYPE_ASYNCIO = asyncio coroutine</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.set_pin_mode', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.set_pin_mode" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">set_pin_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">callback_type</span><span class="o">=</span><span class="n">Constants</span><span class="o">.</span><span class="n">CB_TYPE_ASYNCIO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method sets the pin mode for the specified pin.</span>
<span class="sd">    For Servo, use servo_config() instead.</span>
<span class="sd">    :param pin_number: Arduino Pin Number</span>
<span class="sd">    :param pin_state: INPUT/OUTPUT/ANALOG/PWM/PULLUP - for SERVO use</span>
<span class="sd">                      servo_config()</span>
<span class="sd">    :param callback: Optional: A reference to a call back function to be</span>
<span class="sd">                     called when pin data value changes</span>
<span class="sd">    :param callback_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                    Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># There is a potential start up race condition when running pymata3.</span>
    <span class="c1"># This is a workaround for that race condition</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">):</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">callback</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
        <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb</span> <span class="o">=</span> <span class="n">callback</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">[</span><span class="n">pin_number</span><span class="p">]</span><span class="o">.</span><span class="n">cb_type</span> <span class="o">=</span> <span class="n">callback_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;set_pin_mode: callback ignored for &#39;</span>
                                     <span class="s1">&#39;pin state:&#39;</span><span class="p">,</span> <span class="n">pin_state</span><span class="p">))</span>
    <span class="n">pin_mode</span> <span class="o">=</span> <span class="n">pin_state</span>
    <span class="k">if</span> <span class="n">pin_mode</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
        <span class="n">pin_number</span> <span class="o">=</span> <span class="n">pin_number</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SET_PIN_MODE</span><span class="p">,</span> <span class="n">pin_number</span><span class="p">,</span> <span class="n">pin_mode</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">ANALOG</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_analog_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pin_state</span> <span class="o">==</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_digital_reporting</span><span class="p">(</span><span class="n">pin_number</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mo">05</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.set_sampling_interval">
    <p>def <span class="ident">set_sampling_interval</span>(</p><p>self, interval)</p>
    </div>
    

    
  
    <div class="desc"><p>This method sends the desired sampling interval to Firmata.
Note: Standard Firmata  will ignore any interval less than
      10 milliseconds</p>
<p>:param interval: Integer value for desired sampling interval
                 in milliseconds</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.set_sampling_interval', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.set_sampling_interval" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">set_sampling_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method sends the desired sampling interval to Firmata.</span>
<span class="sd">    Note: Standard Firmata  will ignore any interval less than</span>
<span class="sd">          10 milliseconds</span>
<span class="sd">    :param interval: Integer value for desired sampling interval</span>
<span class="sd">                     in milliseconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">interval</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SAMPLING_INTERVAL</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.shutdown">
    <p>def <span class="ident">shutdown</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method attempts an orderly shutdown
If any exceptions are thrown, just ignore them.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.shutdown', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.shutdown" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method attempts an orderly shutdown</span>
<span class="sd">    If any exceptions are thrown, just ignore them.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">shutdown_flag</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="c1"># stop all reporting - both analog and digital</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)):</span>
       <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_analog_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)):</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">disable_digital_reporting</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">reset_input_buffer</span><span class="p">()</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial_port</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.sleep">
    <p>def <span class="ident">sleep</span>(</p><p>self, sleep_time)</p>
    </div>
    

    
  
    <div class="desc"><p>This method is a proxy method for asyncio.sleep</p>
<p>:param sleep_time: Sleep interval in seconds</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.sleep', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.sleep" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sleep_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method is a proxy method for asyncio.sleep</span>
<span class="sd">    :param sleep_time: Sleep interval in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;sleep exception&#39;</span><span class="p">):</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.sonar_config">
    <p>def <span class="ident">sonar_config</span>(</p><p>self, trigger_pin, echo_pin, cb=None, ping_interval=50, max_distance=200, cb_type=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Configure the pins,ping interval and maximum distance for an HC-SR04
type device.
Single pin configuration may be used. To do so, set both the trigger
and echo pins to the same value.
Up to a maximum of 6 SONAR devices is supported
If the maximum is exceeded a message is sent to the console and the
request is ignored.
NOTE: data is measured in centimeters</p>
<p>:param trigger_pin: The pin number of for the trigger (transmitter).</p>
<p>:param echo_pin: The pin number for the received echo.</p>
<p>:param cb: optional callback function to report sonar data changes</p>
<p>:param ping_interval: Minimum interval between pings. Lowest number
                      to use is 33 ms. Max is 127ms.</p>
<p>:param max_distance: Maximum distance in cm. Max is 200.</p>
<p>:param cb_type: Constants.CB_TYPE_DIRECT = direct call or
                Constants.CB_TYPE_ASYNCIO = asyncio coroutine</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.sonar_config', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.sonar_config" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">cb</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">ping_interval</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">cb_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure the pins,ping interval and maximum distance for an HC-SR04</span>
<span class="sd">    type device.</span>
<span class="sd">    Single pin configuration may be used. To do so, set both the trigger</span>
<span class="sd">    and echo pins to the same value.</span>
<span class="sd">    Up to a maximum of 6 SONAR devices is supported</span>
<span class="sd">    If the maximum is exceeded a message is sent to the console and the</span>
<span class="sd">    request is ignored.</span>
<span class="sd">    NOTE: data is measured in centimeters</span>
<span class="sd">    :param trigger_pin: The pin number of for the trigger (transmitter).</span>
<span class="sd">    :param echo_pin: The pin number for the received echo.</span>
<span class="sd">    :param cb: optional callback function to report sonar data changes</span>
<span class="sd">    :param ping_interval: Minimum interval between pings. Lowest number</span>
<span class="sd">                          to use is 33 ms. Max is 127ms.</span>
<span class="sd">    :param max_distance: Maximum distance in cm. Max is 200.</span>
<span class="sd">    :param cb_type: Constants.CB_TYPE_DIRECT = direct call or</span>
<span class="sd">                    Constants.CB_TYPE_ASYNCIO = asyncio coroutine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># if there is an entry for the trigger pin in existence, just exit</span>
    <span class="k">if</span> <span class="n">trigger_pin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">max_distance</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
        <span class="n">max_distance</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">max_distance_lsb</span> <span class="o">=</span> <span class="n">max_distance</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
    <span class="n">max_distance_msb</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_distance</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">echo_pin</span><span class="p">,</span> <span class="n">ping_interval</span><span class="p">,</span> <span class="n">max_distance_lsb</span><span class="p">,</span>
            <span class="n">max_distance_msb</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_pin_mode</span><span class="p">(</span><span class="n">echo_pin</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">SONAR</span><span class="p">,</span> <span class="n">Constants</span><span class="o">.</span><span class="n">INPUT</span><span class="p">)</span>
    <span class="c1"># update the ping data map for this pin</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sonar_config: maximum number of devices assigned&#39;</span>
              <span class="s1">&#39; - ignoring request&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="p">[</span><span class="n">trigger_pin</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cb</span><span class="p">,</span> <span class="n">cb_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">SONAR_CONFIG</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.sonar_data_retrieve">
    <p>def <span class="ident">sonar_data_retrieve</span>(</p><p>self, trigger_pin)</p>
    </div>
    

    
  
    <div class="desc"><p>Retrieve Ping (HC-SR04 type) data. The data is presented as a
dictionary.
The 'key' is the trigger pin specified in sonar_config()
and the 'data' is the current measured distance (in centimeters)
for that pin. If there is no data, the value is set to None.</p>
<p>:param trigger_pin: key into sonar data map</p>
<p>:returns: active_sonar_map</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.sonar_data_retrieve', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.sonar_data_retrieve" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">sonar_data_retrieve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trigger_pin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve Ping (HC-SR04 type) data. The data is presented as a</span>
<span class="sd">    dictionary.</span>
<span class="sd">    The &#39;key&#39; is the trigger pin specified in sonar_config()</span>
<span class="sd">    and the &#39;data&#39; is the current measured distance (in centimeters)</span>
<span class="sd">    for that pin. If there is no data, the value is set to None.</span>
<span class="sd">    :param trigger_pin: key into sonar data map</span>
<span class="sd">    :returns: active_sonar_map</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sonar_pin_entry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_sonar_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">trigger_pin</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">sonar_pin_entry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.start">
    <p>def <span class="ident">start</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method may be called directly, but first set the autostart
parameter to false.</p>
<p>This method instantiates the serial interface and then performs auto pin
discovery.
Use this method if you wish to start PymataExpress manually from
a non-asyncio function - it used by <strong>init</strong>.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.start', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.start" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method may be called directly, but first set the autostart</span>
<span class="sd">    parameter to false.</span>
<span class="sd">    This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">    discovery.</span>
<span class="sd">    Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">    a non-asyncio function - it used by __init__.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
    <span class="c1"># get arduino firmware version and print it</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Retrieving Arduino Firmware ID...&#39;</span><span class="p">)</span>
        <span class="n">firmware_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">())</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Is your serial cable plugged in and do you have the correct Firmata sketch loaded?&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Is the COM port correct?&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>
    <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
    <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
              <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">())</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>
    <span class="c1"># custom assemble the pin lists</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
            <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                  <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                  <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.start_aio">
    <p>def <span class="ident">start_aio</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>This method may be called directly, but first set the autostart
parameter to false.</p>
<p>This method instantiates the serial interface and then performs auto pin
discovery.
Use this method if you wish to start PymataExpress manually from
an asyncio function.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.start_aio', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.start_aio" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">start_aio</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This method may be called directly, but first set the autostart</span>
<span class="sd">    parameter to false.</span>
<span class="sd">    This method instantiates the serial interface and then performs auto pin</span>
<span class="sd">    discovery.</span>
<span class="sd">    Use this method if you wish to start PymataExpress manually from</span>
<span class="sd">    an asyncio function.</span>
<span class="sd">     &quot;&quot;&quot;</span>
    <span class="c1"># start the command dispatcher loop</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">the_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_arduino_report_dispatcher</span><span class="p">())</span>
    <span class="c1"># get arduino firmware version and print it</span>
    <span class="n">firmware_version</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_firmware_version</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">firmware_version</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Firmware Version retrieval timed out. ***&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Firmata sketch uploaded to the board and are connected&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;to the correct serial port.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;To see a list of serial ports, type: &quot;list_serial_ports&quot; in your console.&#39;</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Arduino Firmware ID: &quot;</span> <span class="o">+</span> <span class="n">firmware_version</span><span class="p">)</span>
    <span class="c1"># try to get an analog pin map. if it comes back as none - shutdown</span>
    <span class="n">report</span> <span class="o">=</span> <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_analog_map</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">report</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;*** Analog map retrieval timed out. ***&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Do you have Arduino connectivity and do you have a &#39;</span>
              <span class="s1">&#39;Firmata sketch uploaded to the board?&#39;</span><span class="p">)</span>
        <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span>
    <span class="c1"># custom assemble the pin lists</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">digital_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">digital_data</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pin</span> <span class="o">!=</span> <span class="n">Constants</span><span class="o">.</span><span class="n">IGNORE</span><span class="p">:</span>
            <span class="n">analog_data</span> <span class="o">=</span> <span class="n">PinData</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">analog_data</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{} {} {} {} {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Auto-discovery complete. Found&#39;</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">),</span>
                                  <span class="s1">&#39;Digital Pins and&#39;</span><span class="p">,</span>
                                  <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">),</span>
                                  <span class="s1">&#39;Analog Pins</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">first_analog_pin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">digital_pins</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">analog_pins</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.stepper_config">
    <p>def <span class="ident">stepper_config</span>(</p><p>self, steps_per_revolution, stepper_pins)</p>
    </div>
    

    
  
    <div class="desc"><p>Configure stepper motor prior to operation.
This is a FirmataPlus feature.</p>
<p>:param steps_per_revolution: number of steps per motor revolution</p>
<p>:param stepper_pins: a list of control pin numbers - either 4 or 2</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.stepper_config', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.stepper_config" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">steps_per_revolution</span><span class="p">,</span> <span class="n">stepper_pins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Configure stepper motor prior to operation.</span>
<span class="sd">    This is a FirmataPlus feature.</span>
<span class="sd">    :param steps_per_revolution: number of steps per motor revolution</span>
<span class="sd">    :param stepper_pins: a list of control pin numbers - either 4 or 2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_CONFIGURE</span><span class="p">,</span> <span class="n">steps_per_revolution</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
            <span class="p">(</span><span class="n">steps_per_revolution</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">pin</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">)):</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stepper_pins</span><span class="p">[</span><span class="n">pin</span><span class="p">])</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="pymata_express.pymata_express.PymataExpress.stepper_step">
    <p>def <span class="ident">stepper_step</span>(</p><p>self, motor_speed, number_of_steps)</p>
    </div>
    

    
  
    <div class="desc"><p>Move a stepper motor for the number of steps at the specified speed
This is a FirmataPlus feature.</p>
<p>:param motor_speed: 21 bits of data to set motor speed</p>
<p>:param number_of_steps: 14 bits for number of steps &amp; direction
                        positive is forward, negative is reverse</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-pymata_express.pymata_express.PymataExpress.stepper_step', this);">Show source &equiv;</a></p>
  <div id="source-pymata_express.pymata_express.PymataExpress.stepper_step" class="source">
    <div class="codehilite"><pre><span></span><span class="n">async</span> <span class="k">def</span> <span class="nf">stepper_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">motor_speed</span><span class="p">,</span> <span class="n">number_of_steps</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Move a stepper motor for the number of steps at the specified speed</span>
<span class="sd">    This is a FirmataPlus feature.</span>
<span class="sd">    :param motor_speed: 21 bits of data to set motor speed</span>
<span class="sd">    :param number_of_steps: 14 bits for number of steps &amp; direction</span>
<span class="sd">                            positive is forward, negative is reverse</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">number_of_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">abs_number_of_steps</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">number_of_steps</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_STEP</span><span class="p">,</span> <span class="n">motor_speed</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
            <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">motor_speed</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span>
            <span class="n">abs_number_of_steps</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="p">(</span><span class="n">abs_number_of_steps</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">direction</span><span class="p">]</span>
    <span class="n">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_send_sysex</span><span class="p">(</span><span class="n">PrivateConstants</span><span class="o">.</span><span class="n">STEPPER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
          <h3>Instance variables</h3>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.active_sonar_map" class="name">var <span class="ident">active_sonar_map</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.analog_pins" class="name">var <span class="ident">analog_pins</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.analog_report_differential" class="name">var <span class="ident">analog_report_differential</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.arduino_instance_id" class="name">var <span class="ident">arduino_instance_id</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.arduino_wait" class="name">var <span class="ident">arduino_wait</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.autostart" class="name">var <span class="ident">autostart</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.baud_rate" class="name">var <span class="ident">baud_rate</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.com_port" class="name">var <span class="ident">com_port</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.command_dictionary" class="name">var <span class="ident">command_dictionary</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.digital_pins" class="name">var <span class="ident">digital_pins</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.first_analog_pin" class="name">var <span class="ident">first_analog_pin</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.i2c_map" class="name">var <span class="ident">i2c_map</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.keep_alive_interval" class="name">var <span class="ident">keep_alive_interval</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.loop" class="name">var <span class="ident">loop</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.margin" class="name">var <span class="ident">margin</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.period" class="name">var <span class="ident">period</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.query_reply_data" class="name">var <span class="ident">query_reply_data</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.serial_port" class="name">var <span class="ident">serial_port</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.shutdown_flag" class="name">var <span class="ident">shutdown_flag</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.sleep_tune" class="name">var <span class="ident">sleep_tune</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="pymata_express.pymata_express.PymataExpress.the_task" class="name">var <span class="ident">the_task</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
